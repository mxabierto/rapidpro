# -*- coding: utf-8 -*-
# Generated by Django 1.11.6 on 2018-07-16 16:23
from __future__ import unicode_literals

import collections
import uuid

import django.contrib.postgres.fields.jsonb
import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models

import temba.orgs.models
import temba.utils.models

SQL = """

-- index for fast fetching of unsquashed rows
CREATE INDEX flows_flowstartcount_unsquashed
ON flows_flowstartcount(start_id) WHERE NOT is_squashed;
"""


class Migration(migrations.Migration):

    dependencies = [("flows", "0167_initial")]

    operations = [
    migrations.CreateModel(
        name="FlowStartCount",
        fields=[
            ("id", models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name="ID")),
            (
                "is_squashed",
                models.BooleanField(default=False, help_text="Whether this row was created by squashing"),
            ),
            ("count", models.IntegerField(default=0)),
            (
                "start",
                models.ForeignKey(
                    on_delete=django.db.models.deletion.PROTECT, related_name="counts", to="flows.FlowStart"
                ),
            ),
        ],
        options={"abstract": False},
    ),
    migrations.AddField(
        model_name='FlowPathRecentRun',
        name='from_step_uuid',
        field= models.UUIDField(help_text="The UUID of the first step", null=True)
    ),
    migrations.AddField(
        model_name='FlowPathRecentRun',
        name='to_step_uuid',
        field=  models.UUIDField(help_text="The UUID of the second step", null=True)
    ),
    migrations.AddField(
        model_name='FlowRun',
        name='parent_context',
        field=  django.contrib.postgres.fields.jsonb.JSONField(
            help_text="Context of the parent run that triggered us", null=True
        )
    ),
    migrations.AddField(
        model_name='FlowRun',
        name='child_context',
        field=  django.contrib.postgres.fields.jsonb.JSONField(
            help_text="Context of the last child subflow triggered by us", null=True
        ),
    ),
    migrations.AddField(
        model_name='FlowRun',
        name='events',
        field=  django.contrib.postgres.fields.jsonb.JSONField(
            help_text="The events recorded on this run in JSON format", null=True, verbose_name="Fields"
        ),
    ),
    migrations.AddField(
        model_name='FlowRun',
        name='delete_reason',
        field=  models.CharField(
            choices=[(("A", "Archive delete"), ("U", "User delete"))],
            help_text="Why the run is being deleted",
            max_length=1,
            null=True,
        ),
    ),
    migrations.AlterIndexTogether(name="flowruncount", index_together=set([("flow", "exit_type")])),

    migrations.AlterIndexTogether(
            name="flowpathcount", index_together=set([("flow", "from_uuid", "to_uuid", "period")])
        ),
    migrations.AlterUniqueTogether(name="flowlabel", unique_together=set([("name", "parent", "org")])),
    migrations.RunSQL(SQL)]
