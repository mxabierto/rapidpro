(function(){var app;app=angular.module('app',['ui.sortable','ui.bootstrap','ngAnimate','angularFileUpload','monospaced.elastic','temba.validation','temba.services','temba.controllers','temba.directives','temba.widgets']);app.config(['$httpProvider','$sceDelegateProvider',function($httpProvider,$sceDelegateProvider){$httpProvider.defaults.xsrfCookieName='csrftoken';$httpProvider.defaults.xsrfHeaderName='X-CSRFToken';return $sceDelegateProvider.resourceUrlWhitelist(['self','http://*.s3.amazonaws.com/**','https://*.s3.amazonaws.com/**','http://textit.ngrok.com/**','https://textit.ngrok.com/**','http://textit.ngrok.io/**','https://textit.ngrok.io/**']);}]);app.config(['$compileProvider','$interpolateProvider',function($compileProvider,$interpolateProvider){$interpolateProvider.startSymbol("[[");return $interpolateProvider.endSymbol("]]");}]);app.run(function($rootScope,Flow,utils){$rootScope.oxford=function(parts,quotes){var last,part,result;if(quotes==null){quotes=false;}
result="";if(parts){parts=utils.clone(parts);if(quotes){for(part in parts){parts[part]='"'+parts[part]+'"';}}
last=parts.pop();result=parts.join(', ');if(parts.length>1){result+=',';}
if(parts.length>0){result+=' and ';}
result+=last;}
return result;};return $rootScope.hasInvalidFields=function(inputs){var completion,i,input,len;completion=new AutoComplete(Flow.completions);for(i=0,len=inputs.length;i<len;i++){input=inputs[i];completion.findInvalidFields(input);}
this.invalidFields=completion.getInvalidFields();return this.invalidFields.length>0;};});angular.module('template/modal/backdrop.html',[]).run(['$templateCache',function($templateCache){$templateCache.put('template/modal/backdrop.html','<div class="modal-backdrop"\n'+'     ng-style="{\'z-index\': 1040 + (index && 1 || 0) + index*10}"\n'+'></div>\n'+'');}]);angular.module('template/modal/window.html',[]).run(['$templateCache',function($templateCache){$templateCache.put('template/modal/window.html','<div tabindex="-1" role="dialog" class="modal" ng-style="{\'z-index\': 1050 + index*10, display: \'block\'}" ng-click="close($event)">\n'+'    <div class="modal-dialog" ng-class="{\'modal-sm\': size == \'sm\', \'modal-lg\': size == \'lg\'}"><div class="modal-content" ng-transclude></div></div>\n'+'</div>');}]);}).call(this);(function(){var REGEX_ALPHANUM,REGEX_NUMBER,REGEX_VARIABLE,app;app=angular.module('temba.validation',[]);REGEX_NUMBER=/^\-?\d+[\.\d+]*$/;REGEX_ALPHANUM=/^[a-z\d\-_\s]+$/i;REGEX_VARIABLE=/^[ ]*@.+$/i;app.directive("number",function(){return{require:"ngModel",link:function(scope,elm,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){if(!viewValue||REGEX_NUMBER.test(viewValue)){ctrl.$setValidity("number",true);return viewValue;}else{ctrl.$setValidity("number",false);return void 0;}});}};});app.directive("alphanum",function(){return{require:"ngModel",link:function(scope,elm,attrs,ctrl){ctrl.$parsers.unshift(function(viewValue){if(!viewValue||REGEX_ALPHANUM.test(viewValue)){ctrl.$setValidity("alphanum",true);return viewValue;}else{ctrl.$setValidity("alphanum",false);return void 0;}});}};});app.directive("lowerThan",function($log){var link;link=function($scope,$element,$attrs,ctrl){var validate;validate=function(viewValue){var comparisonModel,left,right;comparisonModel=$attrs.lowerThan;left=parseFloat(viewValue);right=parseFloat(comparisonModel);if(!isNaN(left)&&!isNaN(right)){if(!viewValue||!comparisonModel){ctrl.$setValidity("lowerThan",true);}
ctrl.$setValidity("lowerThan",left<right);}else{ctrl.$setValidity("lowerThan",true);}
return viewValue;};ctrl.$parsers.unshift(validate);ctrl.$formatters.push(validate);$attrs.$observe("lowerThan",function(comparisonModel){ctrl.$$lastCommittedViewValue=void 0;ctrl.$$invalidModelValue=void 0;return ctrl.$setViewValue(ctrl.$viewValue,true,true);});};return{require:"ngModel",link:link};});app.directive("validateType",function(){var link;link=function($scope,$element,$attrs,ctrl){var validate;validate=function(viewValue){var numeric,type;type=$attrs.validateType;if(type==='eq'||type==='lt'||type==='gt'){numeric=parseFloat(viewValue);ctrl.$setValidity("validateType",!isNaN(numeric)||REGEX_VARIABLE.test(viewValue));}else{ctrl.$setValidity("validateType",true);}
return viewValue;};ctrl.$parsers.unshift(validate);ctrl.$formatters.push(validate);$attrs.$observe("validateType",function(comparisonModel){return validate(ctrl.$viewValue);});};return{require:"ngModel",link:link};});}).call(this);(function(){var app,makeSelect2Required,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;};app=angular.module('temba.widgets',[]);app.directive("ussd",["$rootScope","$log","Flow",function($rootScope,$log,Flow){var MESSAGE_LENGTH,link;MESSAGE_LENGTH=182;link=function(scope,element,attrs){var base,base1,base2,insertEmpty,isVisible,menu,name,refreshMenu,updateCategory;scope.USSD_MENU=parseInt(attrs.ussd)===0;scope.USSD_RESPONSE=parseInt(attrs.ussd)===1;scope.ruleset.ruleset_type=scope.USSD_MENU?"wait_menu":"wait_ussd";if((base=scope.ruleset).config==null){base.config={};}
if((base1=scope.ruleset.config).ussd_message==null){base1.ussd_message={};}
if((base2=scope.ruleset.config.ussd_message)[name=Flow.flow.base_language]==null){base2[name]="";}
isVisible=function(rule){var ref;return ref=Flow.flow.flow_type,indexOf.call(rule._config.filter,ref)>=0;};menu=null;(refreshMenu=function(){return menu=scope.ruleset.rules.filter(function(rule){return isVisible(rule);});})();updateCategory=function(item){var categoryName,words;if(!item.category._autoName){return;}
words=item.label[Flow.flow.base_language].trim().split(/\b/);if(words){categoryName=words[0].toUpperCase();item.category._base=categoryName;if(categoryName.length>1){return item.category._base=categoryName.charAt(0)+categoryName.substr(1).toLowerCase();}}};(insertEmpty=function(){var ref,ref1,ref2;refreshMenu();if(scope.USSD_MENU){if(scope.ruleset.rules.filter(function(rule){return!rule.label&&isVisible(rule);})){scope.ruleset.rules=scope.ruleset.rules.filter(function(rule){return rule.label||(!rule.label&&!isVisible(rule));});refreshMenu();}
if(menu.length===0||((ref=menu[menu.length-1].category)!=null?ref._base:void 0)!==""){return scope.ruleset.rules.splice(menu.length,0,{_config:Flow.getOperatorConfig("eq"),uuid:uuid(),label:{},test:{type:'eq',_base:menu.length>=9?0:menu.length+1},category:{_autoName:true,_base:""}});}}else{if(((ref1=menu[menu.length-1])!=null?(ref2=ref1.category)!=null?ref2._base:void 0:void 0)===""){return scope.ruleset.rules.splice(menu.length-1,1);}}})();scope.remove=function(item,index){refreshMenu();scope.ruleset.rules.splice(index,1);if(index===0||index===menu.length-1){return insertEmpty();}};scope.updateMenu=function(item,index){refreshMenu();scope.countCharacters();updateCategory(item);if(item.label[Flow.flow.base_language].length===1&&index===menu.length-1){return insertEmpty();}};return(scope.countCharacters=function(){var sumMenuItems,textLength,textMenuLength;sumMenuItems=function(items){return items.filter(function(rule){return isVisible(rule);}).reduce(function(prev,current){var base3,name1;if((base3=current.label)[name1=Flow.flow.base_language]==null){base3[name1]="";}
return prev+current.test._base.toString().length+current.label[Flow.flow.base_language].length+2;},0);};textLength=scope.ruleset.config.ussd_message[Flow.flow.base_language].length;if(scope.USSD_MENU){textMenuLength=textLength+1+sumMenuItems(scope.ruleset.rules);}
return $rootScope.characters=scope.USSD_MENU?MESSAGE_LENGTH-textMenuLength:MESSAGE_LENGTH-textLength;})();};return{templateUrl:"/partials/ussd_directive",restrict:"A",link:link,scope:true};}]);app.directive("msg",["$log","Flow",function($log,Flow){var link;link=function(scope,element,attrs){var messageLength,msgType;msgType=attrs.type?attrs.type:"sms";if(msgType==="sms"){messageLength=160;}else if(msgType==="ussd"){messageLength=182;}
scope.showCounter=true;if(attrs.showCounter!=null){scope.showCounter=eval(attrs.showCounter);}
scope.countCharacters=function(){var length,modelController;if(scope.message){if(msgType==="sms"){length=scope.message.length;scope.messages=Math.ceil(length/messageLength);scope.characters=scope.messages*messageLength-length;}
if(msgType==="ussd"){length=scope.message.length;scope.characters=messageLength-length;modelController=element.find('textarea').controller('ngModel');return modelController!=null?modelController.$setValidity('message',scope.characters>=0):void 0;}}else{scope.messages=0;return scope.characters=messageLength;}};scope.$watch((function(){return scope.message;}),scope.countCharacters);if(scope.msg){scope.message=scope.msg[Flow.flow.base_language];if(!scope.message){return scope.message="";}}};return{templateUrl:"/partials/msg_directive",restrict:"A",link:link,scope:{msg:'=',message:'='}};}]);app.directive("autoComplete",["$rootScope","$timeout","$http","$log","Flow",function($rootScope,$timeout,$http,$log,Flow){var link;link=function(scope,element,attrs){return new AutoComplete(Flow.completions,Flow.function_completions).bind(element);};return{restrict:'A',link:link};}]);makeSelect2Required=function(scope,field,element){var data,select2;select2=element.data('select2');data=select2.data();if(data&&!Array.isArray(data)){data=[data];}
field['selected']=data;return element.on('change',function(e){data=select2.data();if(data&&!Array.isArray(data)){data=[data];}
field['selected']=data;return scope.$evalAsync(function(){if(field['selected']&&field['selected'].length>0){return field.$setValidity("required",true);}else{field.$setValidity("required",false);}});});};app.directive("selectServer",["$timeout","$http",function($timeout,$http){var link;link=function(scope,element,attrs,form){var minimumResultsForSearch;minimumResultsForSearch=-1;if(attrs.search){minimumResultsForSearch=0;}
element.select2({placeholder:attrs.placeholder,minimumResultsForSearch:minimumResultsForSearch,ajax:{url:attrs.selectServer,dataType:"json",data:function(term,page){return{search:term,page:page};},results:function(response,page,context){return response;}},escapeMarkup:function(m){return m;}});if(attrs.initId&&attrs.initText){element.data('select2').data({id:attrs.initId,text:attrs.initText});}
if(attrs.required){makeSelect2Required(scope,form[attrs['name']],element);}
return $timeout(function(){return element.trigger('change');},0);};return{restrict:'A',require:'^form',link:link};}]);app.directive("select2",["$timeout",function($timeout){var link;link=function(scope,element,attrs){element.select2({minimumResultsForSearch:-1,placeholder:attrs.placeholder});return $timeout(function(){return element.trigger('change');},0);};return{restrict:'AC',link:link};}]);app.directive("selectLabel",["$timeout","Flow",function($timeout,Flow){var link;link=function(scope,element,attrs,form){var field,i,initLabels,label,len,ref,select2;element.select2({tags:Flow.labels,multiple:true});field=form[attrs['name']];select2=element.data('select2');if(scope.ngModel){initLabels=[];ref=scope.ngModel;for(i=0,len=ref.length;i<len;i++){label=ref[i];initLabels.push({id:label.uuid,text:label.name});}
select2.data(initLabels);}
field['selected']=select2.data();element.on('select2-selecting',function(e){if(e.val.length<1){e.preventDefault();return;}
if(e.val[0]==='@'){element.select2("search",e.val.slice(1));return e.preventDefault();}});element.on('change',function(e){field['selected']=select2.data();if(attrs.required){if(!field['selected']||field['selected'].length===0){select2.container.find('.select2-choices').addClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",false);});}else{select2.container.find('.select2-choices').removeClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",true);});}}});return $timeout(function(){return element.trigger('change');},0);};return{require:'^form',restrict:'A',link:link,scope:{ngModel:'='}};}]);app.directive("selectEmail",["$timeout",function($timeout){var link;link=function(scope,element,attrs,form){if(scope.ngModel){element.val(scope.ngModel.join());}
element.select2({tags:[],multiple:true,selectOnBlur:true,minimumInputLength:1,minimumResultsForSearch:-1,formatInputTooShort:function(term,minLength){return"";},matcher:function(term,text,opt){return text.toUpperCase().indexOf(term.toUpperCase())===0;},formatNoMatches:function(term){return gettext("Enter a valid e-mail address or field");},createSearchChoice:function(term,data){if($(data).filter(function(){return this.text.localeCompare(term)===0;}).length===0){if(/^@[a-zA-Z._]+|^[^@]+@([^@\.]+\.)+[^@\.]+$/.test(term)){return{id:term,text:term};}else{return null;}}}});if(attrs.required){makeSelect2Required(scope,form[attrs['name']],element);}
return $timeout(function(){return element.trigger('change');},0);};return{require:'^form',restrict:'A',link:link,scope:{ngModel:'='}};}]);app.directive("selectStatic",['$timeout',function($timeout){var link;link=function(scope,element,attrs,form){var field,initial,select2,staticData;staticData=JSON.parse(attrs.selectStatic);element.select2({data:staticData,minimumInputLength:0,query:function(query){var cleaned_query,d,data,exact_match,i,len,ref;data={results:[]};cleaned_query=query.term?query.term.toLowerCase().strip():"";exact_match=false;ref=this['data'];for(i=0,len=ref.length;i<len;i++){d=ref[i];if(d.text){if(!query.term||d.text.toLowerCase().indexOf(cleaned_query)!==-1){data.results.push({id:d.id,text:d.text});if(d.text.toLowerCase()===cleaned_query){exact_match=true;}}}}
if(!exact_match&&cleaned_query.length>0&&cleaned_query.length<=36&&/^[a-z0-9-][a-z0-9- ]*$/.test(cleaned_query)){data.results.push({id:'[_NEW_]'+query.term,text:gettext('Add new variable')+': '+query.term});}
return query.callback(data);},formatNoMatches:function(term){return gettext("Enter a valid name, only letters, numbers, dashes and spaces are allowed");},createSearchChoice:function(term,data){return data;}});field=form[attrs['name']];select2=element.data('select2');initial={};if(attrs.key&&attrs.text){initial={id:attrs.key,text:attrs.text};select2.data(initial);}
field['selected']=select2.data();element.on('change',function(e){field['selected']=select2.data();if(attrs.required){if(!field['selected']||field['selected'].length===0){select2.container.find('.select2-choices').addClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",false);});}else{select2.container.find('.select2-choices').removeClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",true);});}}});return $timeout(function(){return element.trigger('change');},0);};return{restrict:"A",require:"^form",link:link};}]);app.directive("omnibox",["$timeout","$log","Flow",function($timeout,$log,Flow){var arbitraryAddFunction,extraAndArbitraryAddFunction,link,omniArbitraryNumberOption,omniFormatOmniboxItem,omniFormatOmniboxOption,omniFormatOmniboxSelection,omniRemap,omnibox,parseData;omniRemap=function(element,callback){callback();};omniArbitraryNumberOption=function(term,data){if(anon_org){return null;}
if($(data).filter(function(){return this.text.localeCompare(term)===0;}).length===0){if(!isNaN(parseFloat(term))&&isFinite(term)){return{id:"n-"+term,text:term};}}};omniFormatOmniboxSelection=function(item){if(item.length===0){return"";}
return omniFormatOmniboxItem(item);};omniFormatOmniboxOption=function(item,container,query){if(query.term[0]==="+"){query.term=query.term.substring(1,query.length);}
return omniFormatOmniboxItem(item);};omniFormatOmniboxItem=function(item){var clazz,text;text=item.text;if(item.extra!=null){text=item.text+" ("+item.extra+")";}
clazz='';if(item.id.indexOf("g-")===0){clazz='omni-group';}else if(item.id.indexOf("c-")===0){clazz='omni-contact';}else if(item.id.indexOf("u-")===0){if(item.scheme==='tel'){clazz='omni-tel';}else if(item.scheme==='twitter'){clazz='omni-twitter';}}
return'<div class="omni-option '+clazz+'">'+text+'</div>';};arbitraryAddFunction=function(term,data){if(term.indexOf('@')!==0&&data.length===0){return{id:term,text:term};}};extraAndArbitraryAddFunction=function(term,data){if(/^@extra.(\w+)(\.\w+)*$/.test(term)){return{id:term,text:term};}else{return arbitraryAddFunction(term,data);}};omnibox=function(ele,options){var data,idx,multiple,placeholder,q,types,v;data=[];if(options===undefined){options={};}
if(options.completions){for(idx in options.completions){v="@"+options.completions[idx].name.toLowerCase();data.push({id:v,text:v});}}
if(options.types){types=options.types;}else{types='cg';}
if(options.types==='g'){placeholder=gettext("Enter one or more contact groups");}else if(options.types==='c'){placeholder=gettext("Recipients, enter contacts");}else{placeholder=gettext("Recipients, enter contacts or groups");}
ele.attr("placeholder",placeholder);q="";if(options.arbitraryAdd){if(options.allowExtra){options.createSearchChoice=extraAndArbitraryAddFunction;}else{options.createSearchChoice=arbitraryAddFunction;}}else if(!options.createSearchChoice&&types&&types.indexOf('u')>=0){options.createSearchChoice=omniArbitraryNumberOption;}
multiple=true;if(options.multiple!==undefined){multiple=options.multiple;}
ele.removeClass("loading").select2({placeholder:placeholder,data:data,allowClear:false,initSelection:omniRemap,selectOnBlur:false,minimumInputLength:0,multiple:multiple,createSearchChoice:options.createSearchChoice,ajax:{url:"/contact/omnibox/?types="+types,dataType:"json",data:function(term,page,context){q=term;return{search:term,page:page};},results:function(response,page,context){var variable;if(data&&q){q=q.toLowerCase();if(q.indexOf("@")===0){for(idx in data){variable=data[idx];if(variable.id.indexOf(q)===0){response.results.unshift(variable);}}}}
return response;}},escapeMarkup:function(m){return m;},containerCssClass:"omnibox-select2",formatSelection:omniFormatOmniboxSelection,formatResult:omniFormatOmniboxOption});if(options.sortable){$(ele).select2("container").find("ul.select2-choices").sortable({containment:'parent',start:function(){return $(ele).select2("onSortStart");},stop:function(){return $(ele).select2("onSortEnd");}});}
return ele;};parseData=function(data){var contacts,groups,i,item,len,variables;groups=[];contacts=[];variables=[];for(i=0,len=data.length;i<len;i++){item=data[i];if(item.id[0]==='g'){groups.push({id:item.id.slice(2),name:item.text});}else if(item.id[0]==='c'){contacts.push({id:item.id.slice(2),name:item.text});}else if(item.id[0]==='@'){variables.push({id:item.id,name:item.id});}else{groups.push(item.text);}}
return{groups:groups,contacts:contacts,variables:variables,total:groups.length+contacts.length+variables.length};};link=function(scope,element,attrs,form){var contact,data,field,group,i,j,k,len,len1,len2,options,ref,ref1,ref2,select2,variable;options={};if(attrs.omnibox){options=JSON.parse(attrs.omnibox);}
if(options.completions){options.completions=Flow.completions;}
data=[];if(scope.groups){ref=scope.groups;for(i=0,len=ref.length;i<len;i++){group=ref[i];if(group.name){data.push({id:'g-'+group.uuid,text:group.name});}else{data.push({id:group,text:group});}}}
if(scope.contacts){ref1=scope.contacts;for(j=0,len1=ref1.length;j<len1;j++){contact=ref1[j];if(contact.name){data.push({id:'c-'+contact.uuid,text:contact.name});}else{data.push({id:contact,text:contact});}}}
if(scope.variables){ref2=scope.variables;for(k=0,len2=ref2.length;k<len2;k++){variable=ref2[k];data.push({id:variable.id,text:variable.id});}}
select2=omnibox(element,options).data('select2');select2.data(data);field=form[attrs['name']];field['selected']=parseData(data);element.on('change',function(e){field['selected']=parseData(select2.data());if(attrs.required){if(field['selected'].total===0){select2.container.find('.select2-choices').addClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",false);});}else{select2.container.find('.select2-choices').removeClass('select2-required');return scope.$apply(function(){return field.$setValidity("required",true);});}}});return $timeout(function(){return element.trigger('change');},0);};return{restrict:"AC",require:"^form",scope:{groups:"=",contacts:"=",variables:"="},link:link};}]);}).call(this);(function(){var ModalController,app,errorRetries,quietPeriod,version,slice=[].slice,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;};app=angular.module('temba.services',[]);version=new Date().getTime();quietPeriod=500;errorRetries=10;app.service("utils",['$modal',function($modal){var isScope,isWindow,toJsonReplacer;isWindow=function(obj){return obj&&obj.document&&obj.location&&obj.alert&&obj.setInterval;};isScope=function(obj){return obj&&obj.$evalAsync&&obj.$watch;};toJsonReplacer=function(key,value){var val;val=value;if(typeof key==="string"&&(key.charAt(0)==="$"||key.charAt(0)==="_")){val=void 0;}else if(isWindow(value)){val="$WINDOW";}else if(value&&document===value){val="$DOCUMENT";}else if(isScope(value)){val="$SCOPE";}
return val;};return{toJson:function(obj,pretty){if(typeof obj==='undefined'){return void 0;}
return JSON.stringify(obj,toJsonReplacer,pretty!=null?pretty:{'  ':null});},clone:function(obj){var flags,key,newInstance;if((obj==null)||typeof obj!=='object'){return obj;}
if(obj instanceof Date){return new Date(obj.getTime());}
if(obj instanceof RegExp){flags='';if(obj.global!=null){flags+='g';}
if(obj.ignoreCase!=null){flags+='i';}
if(obj.multiline!=null){flags+='m';}
if(obj.sticky!=null){flags+='y';}
return new RegExp(obj.source,flags);}
newInstance=new obj.constructor();for(key in obj){newInstance[key]=this.clone(obj[key]);}
return newInstance;},checkCollisions:function(ele){var collision,j,len,node,nodes;nodes=ele.parent().children('.node');collision=false;for(j=0,len=nodes.length;j<len;j++){node=nodes[j];if(node!==ele[0]){if(this.collides($(node),ele)){collision=true;break;}}}
if(collision){return ele.addClass("collision");}else{return ele.removeClass("collision");}},collides:function(a,b){var aBox,aOffset,bBox,bOffset;aOffset=a.offset();bOffset=b.offset();aBox={left:aOffset.left,top:aOffset.top,bottom:a.outerHeight()+aOffset.top,right:a.outerWidth()+aOffset.left};bBox={left:bOffset.left,top:bOffset.top,bottom:b.outerHeight()+bOffset.top,right:b.outerWidth()+bOffset.left};if(aBox.bottom<bBox.top){return false;}
if(aBox.top>bBox.bottom){return false;}
if(aBox.left>bBox.right){return false;}
if(aBox.right<bBox.left){return false;}
return true;},zip:function(){var arr,i,j,length,lengthArray,ref,results;lengthArray=(function(){var j,len,results;results=[];for(j=0,len=arguments.length;j<len;j++){arr=arguments[j];results.push(arr.length);}
return results;}).apply(this,arguments);length=Math.min.apply(Math,lengthArray);results=[];for(i=j=0,ref=length;0<=ref?j<ref:j>ref;i=0<=ref?++j:--j){results.push((function(){var k,len,results1;results1=[];for(k=0,len=arguments.length;k<len;k++){arr=arguments[k];results1.push(arr[i]);}
return results1;}).apply(this,arguments));}
return results;},openModal:function(templateUrl,controller,resolveObj){return $modal.open({keyboard:false,templateUrl:templateUrl,controller:controller,resolve:resolveObj});}};}]);app.service('DragHelper',['$rootScope','$timeout','$log',function($rootScope,$timeout,$log){return{show:function(source,message){var helpText,helper,sourceOffset;sourceOffset=source.offset();helper=$('#drag-helper');helpText=helper.find('.help-text');helper.css('opacity',0);helpText.css('opacity',0).css('left',-10);helper.show();if(message){helper.find('.help-text').html(message);}
helper.offset({left:sourceOffset.left-8,top:sourceOffset.top-20});return helper.animate({top:sourceOffset.top+14,opacity:1},{complete:function(){return helper.find('.help-text').animate({left:30,opacity:1},{duration:200,complete:function(){if($rootScope.dragHelperId){$timeout.cancel($rootScope.dragHelperId);$rootScope.dragHelperId=void 0;}
return $rootScope.dragHelperId=$timeout(function(){return helper.fadeOut();},20000);}});}});},showSaveResponse:function(source){return this.show(source,'To save responses to this message <span class="attn">drag</span> the red box');},showSendReply:function(source){return this.show(source,'To send back a reply <span class="attn">drag</span> the red box');},hide:function(){$('#drag-helper').fadeOut();if($rootScope.dragHelperId){$timeout.cancel($rootScope.dragHelperId);return $rootScope.dragHelperId=void 0;}}};}]);app.service("Plumb",["$timeout","$rootScope","$log",function($timeout,$rootScope,$log){var sourceDefaults,targetDefaults;jsPlumb.setSuspendDrawing(true);$('#flow').css('visibility','hidden');$timeout(function(){$('#flow').css('visibility','visible');jsPlumb.setSuspendDrawing(false);return jsPlumb.repaintEverything();},500);jsPlumb.importDefaults({DragOptions:{cursor:'pointer',zIndex:2000},DropOptions:{tolerance:"touch",hoverClass:"drop-hover"},Endpoint:"Blank",EndpointStyle:{strokeStyle:"transparent"},PaintStyle:{lineWidth:5,strokeStyle:"#98C0D9"},HoverPaintStyle:{strokeStyle:"#27ae60"},HoverClass:"connector-hover",ConnectionsDetachable:window.mutable,Connector:["Flowchart",{stub:12,midpoint:.85,alwaysRespectStubs:false,gap:[0,7],cornerRadius:2}],ConnectionOverlays:[["PlainArrow",{location:.9999,width:12,length:12,foldback:1}]],Container:"flow"});targetDefaults={anchor:["Continuous",{faces:["top","left","right"]}],endpoint:["Rectangle",{width:20,height:20,hoverClass:'endpoint-hover'}],hoverClass:'target-hover',dropOptions:{tolerance:"touch",hoverClass:"drop-hover"},dragAllowedWhenFull:false,deleteEndpointsOnDetach:true,isTarget:true};sourceDefaults={anchor:"BottomCenter",deleteEndpointsOnDetach:true,maxConnections:1,dragAllowedWhenFull:false,isSource:true,paintStyle:{fillStyle:"blue",outlineColor:"black",outlineWidth:1}};return{makeSource:function(sourceId,scope){return $timeout(function(){return jsPlumb.makeSource(sourceId,angular.extend({scope:scope},sourceDefaults));},0);},makeTarget:function(targetId,scope){return $timeout(function(){return jsPlumb.makeTarget(targetId,angular.extend({scope:scope},targetDefaults));},0);},getSourceConnection:function(source){var connections;connections=jsPlumb.getConnections({source:source.attr('id'),scope:'*'});if(connections&&connections.length>0){return connections[0];}},detachSingleConnection:function(connection){return jsPlumb.detach(connection);},recalculateOffsets:function(nodeId){if(window.testing){return;}
return $timeout(function(){jsPlumb.revalidate(nodeId);jsPlumb.recalculateOffsets(nodeId);return jsPlumb.repaint(nodeId);},0);},removeElement:function(id){return jsPlumb.remove(id);},disconnectAllConnections:function(id){jsPlumb.select({target:id}).each(function(connection){return jsPlumb.setSourceEnabled(connection.sourceId,true);});jsPlumb.detachAllConnections(id);return $('#'+id+' .source').each(function(){id=$(this).attr('id');return jsPlumb.detachAllConnections(id);});},disconnectOutboundConnections:function(id){jsPlumb.detachAllConnections(id);if(jsPlumb.isSource(id)){return jsPlumb.setSourceEnabled(id,true);}},setSourceEnabled:function(source,enabled){return jsPlumb.setSourceEnabled(source,enabled);},connect:function(sourceId,targetId,scope,fireEvent){var Plumb,endpoint,existing,j,len,targetPoint;if(fireEvent==null){fireEvent=true;}
sourceId+='_source';Plumb=this;Plumb.disconnectOutboundConnections(sourceId);if(targetId!=null){existing=jsPlumb.getEndpoints(targetId);targetPoint=null;if(existing){for(j=0,len=existing.length;j<len;j++){endpoint=existing[j];if(endpoint.connections.length===0){targetPoint=existing[0];break;}}}
if(!targetPoint){targetPoint=jsPlumb.addEndpoint(targetId,{scope:scope},targetDefaults);}
if(jsPlumb.getConnections({source:sourceId,scope:scope}).length===0){if(jsPlumb.isSource(sourceId)){Plumb.setSourceEnabled(sourceId,true);}
jsPlumb.connect({maxConnections:1,dragAllowedWhenFull:false,deleteEndpointsOnDetach:true,editable:false,source:sourceId,target:targetPoint,fireEvent:fireEvent});return $timeout(function(){Plumb.setSourceEnabled(sourceId,false);return Plumb.repaint(sourceId);},0);}}},updateConnection:function(actionset){var Plumb;Plumb=this;return $timeout(function(){Plumb.disconnectOutboundConnections(actionset.uuid+'_source');if(actionset.destination){Plumb.connect(actionset.uuid,actionset.destination,'rules');}
return Plumb.recalculateOffsets(actionset.uuid);},0);},updateConnections:function(ruleset){var Plumb;Plumb=this;return $timeout(function(){var category,j,len,ref;ref=ruleset._categories;for(j=0,len=ref.length;j<len;j++){category=ref[j];Plumb.connect(ruleset.uuid+'_'+category.source,category.target,'actions');}
return Plumb.recalculateOffsets(ruleset.uuid);},0);},setPageHeight:function(){return $("#flow").each(function(){var $this,pageHeight;pageHeight=0;$this=$(this);$.each($this.children(),function(){var bottom,child;child=$(this);bottom=child.offset().top+child.height();if(bottom>pageHeight){return pageHeight=bottom+500;}});return $this.height(pageHeight);});},repaint:function(element){var service;if(element==null){element=null;}
if(!window.loaded){return;}
service=this;$timeout(function(){if(element){return jsPlumb.repaint(element);}else{return jsPlumb.repaintEverything();}},0);return $timeout(function(){return service.setPageHeight();},0);},disconnectRules:function(rules){var j,len,results,rule;results=[];for(j=0,len=rules.length;j<len;j++){rule=rules[j];results.push(jsPlumb.remove(rule.uuid+'_source'));}
return results;},getConnectionMap:function(selector){var connections;if(selector==null){selector={};}
connections={};jsPlumb.select(selector).each(function(connection){var source;if(connection.targetId&&connection.targetId.length>24){source=connection.sourceId.substr(0,connection.sourceId.lastIndexOf('_'));return connections[source]=connection.targetId;}});return connections;}};}]);app.factory("Revisions",['$http','$log',function($http,$log){var Revisions;return new(Revisions=(function(){function Revisions(){}
Revisions.prototype.updateRevisions=function(flowId){var _this;_this=this;return $http.get('/flow/revisions/'+flowId+'/').success(function(data,status,headers){if(headers('content-type')==='application/json'){return _this.revisions=data;}});};Revisions.prototype.getRevision=function(revision){var _this;_this=this;return $http.get('/flow/revisions/'+flowId+'/?definition='+revision.id).success(function(data,status,headers){if(headers('content-type')==='application/json'){return _this.definition=data;}});};return Revisions;})());}]);app.factory('Flow',['$rootScope','$window','$http','$timeout','$interval','$log','utils','Plumb','Revisions','DragHelper',function($rootScope,$window,$http,$timeout,$interval,$log,utils,Plumb,Revisions,DragHelper){var Flow;return new(Flow=(function(){var ALL,ALL_TEXT,NONE,ONLINE_TEXT,SURVEY,TEXT,USSD,VOICE;TEXT='F';VOICE='V';SURVEY='S';USSD='U';ALL=[TEXT,VOICE,SURVEY,USSD];NONE=[];ALL_TEXT=[TEXT,SURVEY,USSD];ONLINE_TEXT=[TEXT,USSD];function Flow(){this.actions=[{type:'say',name:'Play Message',verbose_name:'Play a message',icon:'icon-bubble-3',message:true,filter:[VOICE]},{type:'play',name:'Play Recording',verbose_name:'Play a contact recording',icon:'icon-mic',filter:[VOICE]},{type:'reply',name:'Send Message',verbose_name:'Send a response message',icon:'icon-bubble-3',message:true,filter:ALL},{type:'end_ussd',name:'End USSD Session',verbose_name:'End USSD session with message',icon:'icon-bubble-3',message:true,filter:USSD},{type:'send',name:'Send Message',verbose_name:'Send a message to somebody else',icon:'icon-bubble-3',message:true,filter:[TEXT,VOICE]},{type:'add_label',name:'Add Label',verbose_name:'Add a label to a Message',icon:'icon-tag',filter:ALL},{type:'save',name:'Update Contact',verbose_name:'Update the contact',icon:'icon-user',filter:ALL},{type:'add_group',name:'Add to Groups',verbose_name:'Add contact to a group',icon:'icon-users-2',groups:true,filter:ALL},{type:'del_group',name:'Remove from Groups',verbose_name:'Remove contact from a group',icon:'icon-users-2',groups:true,filter:ALL},{type:'api',name:'Webhook',verbose_name:'Make a call to an external server',icon:'icon-cloud-upload',filter:[TEXT,VOICE]},{type:'email',name:'Send Email',verbose_name:'Send an email',icon:'icon-bubble-3',filter:[TEXT,VOICE]},{type:'lang',name:'Set Language',verbose_name:'Set language for contact',icon:'icon-language',filter:ALL},{type:'channel',name:'Set Channel',verbose_name:'Set preferred channel',icon:'icon-phone',filter:[TEXT,VOICE]},{type:'flow',name:'Start Another Flow',verbose_name:'Start another flow',icon:'icon-tree',flows:true,filter:[TEXT,VOICE]},{type:'trigger-flow',name:'Start Someone in a Flow',verbose_name:'Start someone else in a flow',icon:'icon-tree',flows:true,filter:[TEXT,VOICE,USSD]}];this.rulesets=[{type:'wait_message',name:'Wait for Response',verbose_name:'Wait for response',split:'message response',filter:[TEXT,SURVEY]},{type:'wait_menu',name:'Wait for USSD Menu',verbose_name:'Wait for USSD Menu',split:'USSD Menu response',filter:USSD},{type:'wait_ussd',name:'Wait for USSD Response',verbose_name:'Wait for USSD response',split:'USSD response',filter:USSD},{type:'wait_photo',name:'Wait for a photo',verbose_name:'Wait for photo',filter:[SURVEY]},{type:'wait_audio',name:'Wait for an audio recording',verbose_name:'Wait for audio',filter:[SURVEY]},{type:'wait_video',name:'Wait for a video',verbose_name:'Wait for video',filter:[SURVEY]},{type:'wait_gps',name:'Wait for GPS coordinates',verbose_name:'Wait for GPS',filter:[SURVEY]},{type:'wait_recording',name:'Get Recording',verbose_name:'Wait for recording',filter:VOICE},{type:'wait_digit',name:'Get Menu Selection',verbose_name:'Wait for menu selection',filter:VOICE},{type:'wait_digits',name:'Get Digits',verbose_name:'Wait for multiple digits',split:'digits',filter:VOICE},{type:'webhook',name:'Call Webhook',verbose_name:'Call webhook',split:'webhook response',filter:[TEXT,VOICE,USSD],rules:[{name:'Success',test:{type:'webhook_status',status:'success'}},{name:'Failure',test:{type:'webhook_status',status:'failure'}}]},{type:'resthook',name:'Call Zapier',verbose_name:'Call Zapier',split:'zapier response',filter:[TEXT,VOICE,USSD],rules:[{name:'Success',test:{type:'webhook_status',status:'success'}},{name:'Failure',test:{type:'webhook_status',status:'failure'}}]},{type:'airtime',name:'Transfer Airtime',verbose_name:'Transfer Airtime',split:'transfer airtime',filter:[TEXT,VOICE],rules:[{name:'Success',test:{type:'airtime_status',exit_status:'success'}},{name:'Failure',test:{type:'airtime_status',exit_status:'failed'}}]},{type:'subflow',name:'Run Flow',verbose_name:'Run a flow',filter:ALL,rules:[{name:'Completed',test:{type:'subflow',exit_type:'completed'}},{name:'Expired',test:{type:'subflow',exit_type:'expired'}}]},{type:'flow_field',name:'Split by Flow Field',verbose_name:'Split by flow field',filter:ALL},{type:'contact_field',name:'Split by Contact Field',verbose_name:'Split by contact field',filter:ALL},{type:'expression',name:'Split by Expression',verbose_name:'Split by expression',filter:ALL},{type:'form_field',name:'Split by Message Form',verbose_name:'Split by message form',filter:ALL},{type:'random',name:'Random Split',verbose_name:'Split randomly',hide_other:true,filter:ALL},{type:'group',name:'Group Membership',verbose_name:'Split by group membership',filter:ALL}];this.exclusiveRules={'subflow':['subflow'],'timeout':['wait_message'],'webhook_status':['webhook','resthook'],'airtime_status':['airtime'],'in_group':['group']};this.supportsRules=['wait_message','wait_menu','wait_ussd','wait_digits','expression','flow_field','contact_field','form_field'];this.operators=[{type:'contains_any',name:'Contains any',verbose_name:'has any of these words',operands:1,localized:true,filter:ALL_TEXT},{type:'contains',name:'Contains all',verbose_name:'has all of the words',operands:1,localized:true,filter:ALL_TEXT},{type:'contains_phrase',name:'Contains Phrase',verbose_name:'has the phrase',operands:1,localized:true,filter:ONLINE_TEXT},{type:'contains_only_phrase',name:'Contains only phrase',verbose_name:'has only the phrase',operands:1,localized:true,filter:ONLINE_TEXT},{type:'not_empty',name:'Not empty',verbose_name:'is not empty',operands:0,localized:true,filter:ALL_TEXT},{type:'starts',name:'Starts with',verbose_name:'starts with',operands:1,localized:true,filter:ALL},{type:'number',name:'Has a number',verbose_name:'has a number',operands:0,filter:ALL},{type:'lt',name:'Less than',verbose_name:'has a number less than',operands:1,filter:ALL},{type:'eq',name:'Equal to',verbose_name:'has a number equal to',operands:1,filter:ALL},{type:'gt',name:'More than',verbose_name:'has a number more than',operands:1,filter:ALL},{type:'between',name:'Number between',verbose_name:'has a number between',operands:2,filter:ALL},{type:'date',name:'Has date',verbose_name:'has a date',operands:0,validate:'date',filter:ALL_TEXT},{type:'date_before',name:'Date before',verbose_name:'has a date before',operands:1,validate:'date',filter:ALL_TEXT},{type:'date_equal',name:'Date equal to',verbose_name:'has a date equal to',operands:1,validate:'date',filter:ALL_TEXT},{type:'date_after',name:'Date after',verbose_name:'has a date after',operands:1,validate:'date',filter:ALL_TEXT},{type:'has_email',name:'Has email',verbose_name:'has an email address',operands:0,filter:ONLINE_TEXT},{type:'phone',name:'Has a phone',verbose_name:'has a phone number',operands:0,filter:ALL},{type:'state',name:'Has a state',verbose_name:'has a state',operands:0,filter:ALL_TEXT},{type:'district',name:'Has a district',verbose_name:'has a district',operands:1,auto_complete:true,placeholder:'@flow.state',filter:ALL_TEXT},{type:'ward',name:'Has a ward',verbose_name:'has a ward',operands:2,operand_required:false,auto_complete:true,filter:ALL_TEXT},{type:'regex',name:'Regex',verbose_name:'matches regex',operands:1,localized:true,filter:ALL},{type:'subflow',name:'Subflow',verbose_name:'subflow',operands:0,filter:NONE},{type:'in_group',name:'Is in group',verbose_name:'is in group',operands:0,filter:NONE},{type:'airtime_status',name:'Airtime Status',verbose_name:'airtime',operands:0,filter:NONE},{type:'webhook',name:'Webhook',verbose_name:'webhook',operands:0,filter:NONE},{type:'webhook_status',name:'Webhook Status',verbose_name:'webhook status',operands:0,filter:NONE},{type:'true',name:'Other',verbose_name:'contains anything',operands:0,filter:NONE},{type:'timeout',name:'Timeout',verbose_name:'timeout',operands:0,filter:NONE},{type:'interrupted_status',name:'Interrupted',verbose_name:'interrupted status',operands:0,filter:NONE}];this.opNames={'lt':'< ','gt':'> ','eq':'','between':'','number':'','starts':'','contains':'','contains_any':'','date':'','date_before':'','date_equal':'','date_after':'','regex':''};}
$rootScope.errorDelay=quietPeriod;Flow.prototype.sanitizeFlow=function(){var action,action_idx,actionset,actionset_idx,base_language,results;base_language=this.flow.base_language;actionset_idx=this.flow.action_sets.length;results=[];while(actionset_idx--){actionset=this.flow.action_sets[actionset_idx];action_idx=actionset.actions.length;while(action_idx--){action=actionset.actions[action_idx];if(action.type==='reply'){if(!action.msg[base_language]){actionset.actions.splice(action_idx,1);}}}
if(actionset.actions.length===0){results.push(this.flow.action_sets.splice(actionset_idx,1));}else{results.push(void 0);}}
return results;};Flow.prototype.determineFlowStart=function(){var actionset,checkTop,j,k,len,len1,ref,ref1,ruleset,topNode;topNode=null;checkTop=function(node){if(topNode===null||node.y<topNode.y){return topNode=node;}else if(topNode===null||topNode.y===node.y){if(node.x<topNode.x){return topNode=node;}}};ref=this.flow.action_sets;for(j=0,len=ref.length;j<len;j++){actionset=ref[j];checkTop(actionset);}
ref1=this.flow.rule_sets;for(k=0,len1=ref1.length;k<len1;k++){ruleset=ref1[k];checkTop(ruleset);}
if(topNode){return this.flow.entry=topNode.uuid;}};Flow=Flow;$rootScope.$watch((function(){return Flow.dirty;}),function(current,prev){var cancelled;if(current){if(!window.mutable){$rootScope.error="Your changes cannot be saved. You don't have permission to edit this flow.";return;}
Flow.dirty=false;Flow.sanitizeFlow();Flow.determineFlowStart();if($rootScope.saving){cancelled=$timeout.cancel($rootScope.saving);if(!cancelled){$timeout(function(){return Flow.dirty=true;},quietPeriod);return;}}
return $rootScope.saving=$timeout(function(){$rootScope.error=null;$log.debug("Saving.");return $http.post('/flow/json/'+Flow.flowId+'/',utils.toJson(Flow.flow)).error(function(data,statusCode){var e,modalInstance,resolveObj;if(statusCode===400){$rootScope.saving=false;try{if(UserVoice){UserVoice.push(['set','ticket_custom_fields',{'Error':data.description}]);}}catch(error1){e=error1;}
resolveObj={type:function(){return"error";},title:function(){return"Error Saving";},body:function(){return"Sorry, but we were unable to save your flow. Please reload the page and try again, this may clear your latest changes.";},details:function(){return data.description;},ok:function(){return'Reload';},hideCancel:function(){return true;},details:function(){return'';}};modalInstance=utils.openModal("/partials/modal?v="+version,ModalController,resolveObj);modalInstance.result.then(function(reload){if(reload){return document.location.reload();}});return;}
$rootScope.errorDelay+=quietPeriod;if($rootScope.errorDelay<(quietPeriod*(errorRetries+1))){$log.debug("Couldn't save changes, trying again in "+$rootScope.errorDelay);return $timeout(function(){$rootScope.saving=false;return Flow.dirty=true;},$rootScope.errorDelay);}else{$rootScope.saving=false;$rootScope.error="Your changes may not be saved. Please check your network connection.";return $rootScope.errorDelay=quietPeriod;}}).success(function(data,statusCode){var modalInstance,resolveObj;$rootScope.error=null;$rootScope.errorDelay=quietPeriod;if(data.status==='failure'){resolveObj={type:function(){return"error";},title:function(){return"Error Saving";},body:function(){return data.description;},ok:function(){return'Reload';},hideCancel:function(){return true;},details:function(){return'';}};modalInstance=utils.openModal("/partials/modal?v="+version,ModalController,resolveObj);modalInstance.result.then(function(reload){if(reload){return document.location.reload();}});}else{Flow.flow.metadata.revision=data.revision;Flow.flow.metadata.saved_on=data.saved_on;$http.get('/flow/completion/?flow='+Flow.flowId).success(function(data){Flow.completions=data.message_completions;Flow.function_completions=data.function_completions;return Flow.variables_and_functions=slice.call(Flow.completions).concat(slice.call(Flow.function_completions));});Revisions.updateRevisions(Flow.flowId);}
return $rootScope.saving=null;});},quietPeriod);}});Flow.prototype.isRuleAllowed=function(ruleset_type,rule_type){var allowed,exclusives,j,len,ref,rule,rulesetConfig;if(rule_type){exclusives=this.exclusiveRules[rule_type];if(exclusives){allowed=indexOf.call(exclusives,ruleset_type)>=0;return allowed;}
rulesetConfig=this.getRulesetConfig({type:ruleset_type});if(rulesetConfig.rules){ref=rulesetConfig.rules;for(j=0,len=ref.length;j<len;j++){rule=ref[j];if(rule.test.type===rule_type){return true;}}
return false;}
return true;}};Flow.prototype.getNode=function(uuid){var actionset,j,k,len,len1,ref,ref1,ruleset;ref=this.flow.action_sets;for(j=0,len=ref.length;j<len;j++){actionset=ref[j];if(actionset.uuid===uuid){return actionset;}}
ref1=this.flow.rule_sets;for(k=0,len1=ref1.length;k<len1;k++){ruleset=ref1[k];if(ruleset.uuid===uuid){return ruleset;}}};Flow.prototype.isPausingRuleset=function(node){if(!(node!=null?node.actions:void 0)){return this.isPausingRulesetType(node.ruleset_type);}
return false;};Flow.prototype.isUssdRuleset=function(node){var ref;if(!(node!=null?node.actions:void 0)){return(ref=node.ruleset_type)==='wait_menu'||ref==='wait_ussd';}
return false;};Flow.prototype.isPausingRulesetType=function(ruleset_type){return ruleset_type==='wait_message'||ruleset_type==='wait_recording'||ruleset_type==='wait_digit'||ruleset_type==='wait_digits';};Flow.prototype.detectLoop=function(nodeId,targetId,path){var j,len,node,ref,results,rule;if(path==null){path=[];}
node=this.getNode(targetId);if(nodeId===targetId&&!this.isUssdRuleset(node)){throw new Error('Loop detected: '+nodeId);}
if(node&&(this.isPausingRuleset(node)||this.isUssdRuleset(node))){return false;}
if(indexOf.call(path,targetId)>=0){throw new Error('Loop detected: '+path+','+targetId);}
path=path.slice();path.push(targetId);if(node!=null?node.rules:void 0){ref=node.rules;results=[];for(j=0,len=ref.length;j<len;j++){rule=ref[j];if(rule.destination){results.push(this.detectLoop(node.uuid,rule.destination,path));}else{results.push(void 0);}}
return results;}else{if(node!=null?node.destination:void 0){return this.detectLoop(node.uuid,node.destination,path);}}};Flow.prototype.isConnectionAllowed=function(sourceId,targetId){return this.getConnectionError(sourceId,targetId)===null;};Flow.prototype.getConnectionError=function(sourceId,targetId){var e,path,source;source=sourceId.split('_')[0];path=[source];try{this.detectLoop(source,targetId,path);}catch(error1){e=error1;$log.debug(e.message);return'Connecting these together would create an infinite loop in your flow. To connect these, make sure to pass it through an action that waits for a response.';}
return null;};Flow.prototype.slugify=function(label){return label.toString().toLowerCase().replace(/([^a-z0-9]+)/g,'_');};Flow.prototype.getFlowFields=function(excludeRuleset){var details,flowFields,id,j,label,len,ref,result,ruleset,uuid;flowFields={};if(this.flow){ref=this.flow.rule_sets;for(j=0,len=ref.length;j<len;j++){ruleset=ref[j];flowFields[this.slugify(ruleset.label)]=[ruleset.uuid,ruleset.label];}}
result=[];for(id in flowFields){details=flowFields[id];uuid=details[0];label=details[1];if(uuid!==(excludeRuleset!=null?excludeRuleset.uuid:void 0)){result.push({id:id,text:label});}}
return result;};Flow.prototype.getFieldSelection=function(fields,operand,isFlowFields){var field,isContact,isFlow,j,len,slugged;isFlow=false;isContact=false;if(operand){if(operand.length>6&&operand.slice(0,5)==='@flow'){isFlow=true;operand=operand.slice(6);}else if(operand.length>9&&operand.slice(0,8)==='@contact'){isContact=true;operand=operand.slice(9);}}
for(j=0,len=fields.length;j<len;j++){field=fields[j];if(field.id===operand){return field;}}
if(operand&&((isFlow&&isFlowFields)||(isContact&&!isFlowFields))){slugged=Flow.slugify(operand);field={id:operand,text:slugged+' (missing)',missing:true};fields.push(field);return field;}
return fields[0];};Flow.prototype.getContactField=function(ruleset){if(Flow.contactFieldSearch){return this.getFieldSelection(Flow.contactFieldSearch,ruleset.operand,false);}};Flow.prototype.getFlowField=function(ruleset){var fields;fields=Flow.getFlowFields(ruleset);return this.getFieldSelection(fields,ruleset.operand,true);};Flow.prototype.applyActivity=function(node,activity){var category,count,j,k,key,len,len1,ref,ref1,source;count=0;if(activity&&activity.active&&node.uuid in activity.active){count=activity.active[node.uuid];}
node._active=count;if(node._categories){ref=node._categories;for(j=0,len=ref.length;j<len;j++){category=ref[j];count=0;if(activity&&activity.visited){ref1=category.sources;for(k=0,len1=ref1.length;k<len1;k++){source=ref1[k];key=source+':'+category.target;if(key in activity.visited){count+=activity.visited[key];}}}
category._visited=count;}}else{count=0;if(activity&&activity.visited){key=node.exit_uuid+':'+node.destination;if(key in activity.visited){count=activity.visited[key];}}
node._visited=count;}};Flow.prototype.deriveCategories=function(ruleset,base_language){var cat,categories,category,existing,j,k,l,len,len1,len2,name,ref,rule,rule_cat;categories=[];ref=ruleset.rules;for(j=0,len=ref.length;j<len;j++){rule=ref[j];if(!rule.uuid){rule.uuid=uuid();}
if(rule.test.type==="between"){if(!rule.category){rule.category={base_language:rule.test.min+"-"+rule.test.max};}}
if(rule.category){rule_cat=rule.category[base_language].toLocaleLowerCase();existing=(function(){var k,len1,results;results=[];for(k=0,len1=categories.length;k<len1;k++){category=categories[k];results.push(category.name[base_language].toLocaleLowerCase());}
return results;})();if(rule.test.type==='true'||indexOf.call(existing,rule_cat)<0){categories.push({name:rule.category,sources:[rule.uuid],target:rule.destination,type:rule.test.type});}else{for(k=0,len1=categories.length;k<len1;k++){cat=categories[k];name=cat.name;if(base_language in cat.name){name=cat.name[base_language];}
if((name!=null?name.toLocaleLowerCase():void 0)===(rule_cat!=null?rule_cat.toLocaleLowerCase():void 0)){cat.sources.push(rule.uuid);if(cat.target){rule.destination=cat.target;}}}}}}
for(l=0,len2=categories.length;l<len2;l++){cat=categories[l];cat.source=cat.sources[0];}
ruleset._categories=categories;this.applyActivity(ruleset,$rootScope.visibleActivity);};Flow.prototype.markDirty=function(){Flow=this;return $timeout(function(){return Flow.dirty=true;},0);};Flow.prototype.updateDestination=function(source,target){var actionset,category,j,k,l,len,len1,len2,len3,m,ref,ref1,ref2,ref3,ref4,resolveObj,results,results1,rule,ruleset,sourceNode,targetNode;source=source.split('_');sourceNode=Flow.getNode(source[0]);targetNode=Flow.getNode(target);if(sourceNode&&targetNode){if(Flow.isPausingRuleset(sourceNode)&&Flow.isPausingRuleset(targetNode)&&source[0]!==target){resolveObj={type:function(){return"warning";},title:function(){return"Warning";},body:function(){return"You've connected two steps that wait for a response. The contact will need to send more than one message to continue through the flow.";},ok:function(){return'Ok';},details:function(){return'';},hideCancel:function(){return false;}};utils.openModal("/partials/modal?v="+version,ModalController,resolveObj);}}
if(source.length>1&&source[source.length-1]==='source'){source.pop();}
if(source.length>1){ref=Flow.flow.rule_sets;results=[];for(j=0,len=ref.length;j<len;j++){ruleset=ref[j];if(ruleset.uuid===source[0]){if(ruleset._categories){ref1=ruleset._categories;for(k=0,len1=ref1.length;k<len1;k++){category=ref1[k];if(category.source===source[1]){category.target=target;ref2=ruleset.rules;for(l=0,len2=ref2.length;l<len2;l++){rule=ref2[l];if(ref3=rule.uuid,indexOf.call(category.sources,ref3)>=0){rule.destination=target;}}
break;}}}
Plumb.updateConnections(ruleset);break;}else{results.push(void 0);}}
return results;}else{ref4=Flow.flow.action_sets;results1=[];for(m=0,len3=ref4.length;m<len3;m++){actionset=ref4[m];if(actionset.uuid===source[0]){actionset.destination=target;Plumb.updateConnection(actionset);this.applyActivity(actionset,$rootScope.activity);break;}else{results1.push(void 0);}}
return results1;}};Flow.prototype.getActionConfig=function(action){var cfg,j,len,ref;ref=this.actions;for(j=0,len=ref.length;j<len;j++){cfg=ref[j];if(cfg.type===action.type){return cfg;}}};Flow.prototype.getRulesetConfig=function(ruleset){var cfg,j,len,ref;ref=this.rulesets;for(j=0,len=ref.length;j<len;j++){cfg=ref[j];if(cfg.type===ruleset.type){return cfg;}}};Flow.prototype.getOperatorConfig=function(operatorType){var cfg,j,len,ref;ref=this.operators;for(j=0,len=ref.length;j<len;j++){cfg=ref[j];if(cfg.type===operatorType){return cfg;}}};Flow.prototype.fetchRecentMessages=function(exit_uuids,to_uuid){return $http.get('/flow/recent_messages/'+Flow.flowId+'/?exits='+exit_uuids.join()+'&to='+to_uuid).success(function(data){});};Flow.prototype.fetch=function(flowId,onComplete){if(onComplete==null){onComplete=null;}
this.flowId=flowId;Revisions.updateRevisions(flowId);Flow=this;return $http.get('/flow/json/'+flowId+'/').success(function(data){var action,actionset,flow,j,k,l,lang,languages,len,len1,len2,len3,m,ref,ref1,ref2,ref3,ref4;flow=data.flow;flow.type=window.flow_type;ref=flow.action_sets;for(j=0,len=ref.length;j<len;j++){actionset=ref[j];ref1=actionset.actions;for(k=0,len1=ref1.length;k<len1;k++){action=ref1[k];if(!action.uuid){action.uuid=uuid();}}}
Flow.channel_countries=data.channel_countries;Flow.channels=data.channels;languages=[];ref2=data.languages;for(l=0,len2=ref2.length;l<len2;l++){lang=ref2[l];if(lang.iso_code===flow.base_language){languages.push(lang);Flow.language=lang;}}
ref3=data.languages;for(m=0,len3=ref3.length;m<len3;m++){lang=ref3[m];if(lang.iso_code!==flow.base_language){languages.push(lang);}}
if(!Flow.language&&flow.base_language){Flow.language={iso_code:flow.base_language};}
if(languages){if(ref4=flow.base_language,indexOf.call((function(){var len4,n,results;results=[];for(n=0,len4=languages.length;n<len4;n++){lang=languages[n];results.push(lang.iso_code);}
return results;})(),ref4)<0){languages.unshift({iso_code:flow.base_language,name:gettext('Default')});}}
Flow.languages=languages;Flow.flow=flow;if(onComplete){onComplete();}
$http.get('/flow/completion/?flow='+flowId).success(function(data){if(data.function_completions&&data.message_completions){Flow.completions=data.message_completions;Flow.function_completions=data.function_completions;return Flow.variables_and_functions=slice.call(Flow.completions).concat(slice.call(Flow.function_completions));}});$http.get('/contactfield/json/').success(function(fields){var contactFieldSearch,field,id,len4,n,text,updateContactSearch;Flow.contactFields=fields;contactFieldSearch=[];updateContactSearch=[];for(n=0,len4=fields.length;n<len4;n++){field=fields[n];id=field.key;text=field.label;contactFieldSearch.push({id:id,text:text});if(field.key==='groups'){continue;}
if(id==='tel_e164'){text='Phone Numbers';}
updateContactSearch.push({id:id,text:text});}
Flow.contactFieldSearch=contactFieldSearch;return Flow.updateContactSearch=updateContactSearch;});$http.get('/label/').success(function(labels){return Flow.labels=labels;});return $timeout(function(){window.loaded=true;return Plumb.repaint();},0);});};Flow.prototype.replaceRuleset=function(ruleset,markDirty){var found,idx,j,len,previous,ref;if(markDirty==null){markDirty=true;}
ruleset._flowFieldName=null;ruleset._contactFieldName=null;found=false;if(!ruleset.operand){ruleset.operand='@step.value';}
ref=Flow.flow.rule_sets;for(idx=j=0,len=ref.length;j<len;idx=++j){previous=ref[idx];if(ruleset.uuid===previous.uuid){this.deriveCategories(ruleset,Flow.flow.base_language);Flow.flow.rule_sets.splice(idx,1,ruleset);found=true;if(markDirty){this.markDirty();}
break;}}
if(!found){Flow.flow.rule_sets.push(ruleset);if(markDirty){this.markDirty();}}
Plumb.repaint();};Flow.prototype.updateTranslationStats=function(){var action,actionset,category,flow,item,items,j,k,l,len,len1,len2,len3,len4,m,missing,n,ref,ref1,ref2,ref3,ref4,ref5,ref6,ruleset;if(this.language){flow=this.flow;items=0;missing=0;ref=flow.action_sets;for(j=0,len=ref.length;j<len;j++){actionset=ref[j];ref1=actionset.actions;for(k=0,len1=ref1.length;k<len1;k++){action=ref1[k];if((ref2=action.type)==='send'||ref2==='reply'||ref2==='say'){items++;if(action._missingTranslation){missing++;}}}}
ref3=flow.rule_sets;for(l=0,len2=ref3.length;l<len2;l++){ruleset=ref3[l];ref4=ruleset._categories;for(m=0,len3=ref4.length;m<len3;m++){category=ref4[m];items++;if(category._missingTranslation){missing++;}}
if((ref5=ruleset.ruleset_type)==="wait_menu"||ref5==="wait_ussd"){items++;if(ruleset.config._missingTranslation){missing++;}
if(ruleset.ruleset_type==="wait_menu"){ref6=ruleset.rules;for(n=0,len4=ref6.length;n<len4;n++){item=ref6[n];items++;if(item._missingTranslation){missing++;}}}}}
flow._pctTranslated=Math.floor(((items-missing)/items)*100);flow._missingTranslation=items>0;if(flow._pctTranslated===100&&flow.base_language!==this.language.iso_code){$rootScope.gearLinks=[{title:'Default Language',id:'default_language'},{id:'divider'}];}else{$rootScope.gearLinks=[];}
return flow._pctTranslated;}};Flow.prototype.setMissingTranslation=function(missing){return Flow.flow._missingTranslation=missing;};Flow.prototype.removeConnection=function(connection){return this.updateDestination(connection.sourceId,null);};Flow.prototype.removeRuleset=function(uuid){var flow;DragHelper.hide();flow=Flow.flow;Flow=this;$timeout(function(){var connections,idx,j,len,ref,results,rs,source;connections=Plumb.getConnectionMap({target:uuid});for(source in connections){Flow.updateDestination(source,null);}
ref=flow.rule_sets;results=[];for(idx=j=0,len=ref.length;j<len;idx=++j){rs=ref[idx];if(rs.uuid===uuid){flow.rule_sets.splice(idx,1);break;}else{results.push(void 0);}}
return results;},0);return this.markDirty();};Flow.prototype.addNote=function(x,y){if(!Flow.flow.metadata.notes){Flow.flow.metadata.notes=[];}
return Flow.flow.metadata.notes.push({x:x,y:y,title:'New Note',body:'...'});};Flow.prototype.removeNote=function(note){var idx;idx=Flow.flow.metadata.notes.indexOf(note);Flow.flow.metadata.notes.splice(idx,1);return this.markDirty();};Flow.prototype.moveActionUp=function(actionset,action){var idx;idx=actionset.actions.indexOf(action);actionset.actions.splice(idx,1);actionset.actions.splice(idx-1,0,action);actionset._lastActionMissingTranslation=null;return this.markDirty();};Flow.prototype.removeActionSet=function(actionset){var flow,service;flow=Flow.flow;service=this;return $timeout(function(){var as,connections,idx,j,len,ref,results,source;connections=Plumb.getConnectionMap({target:actionset.uuid});for(source in connections){service.updateDestination(source,null);}
ref=flow.action_sets;results=[];for(idx=j=0,len=ref.length;j<len;idx=++j){as=ref[idx];if(as.uuid===actionset.uuid){flow.action_sets.splice(idx,1);break;}else{results.push(void 0);}}
return results;},0);};Flow.prototype.removeAction=function(actionset,action){var found,idx,j,len,previous,ref;DragHelper.hide();found=false;ref=actionset.actions;for(idx=j=0,len=ref.length;j<len;idx=++j){previous=ref[idx];if(previous.uuid===action.uuid){actionset.actions.splice(idx,1);found=true;break;}}
if(found){if(actionset.actions.length===0){this.removeActionSet(actionset);}else{Plumb.recalculateOffsets(actionset.uuid);}
this.checkTerminal(actionset);this.markDirty();}};Flow.prototype.checkTerminal=function(actionset){var action,hasMessage,j,len,ref,startsFlow,terminal;hasMessage=false;startsFlow=false;ref=actionset.actions;for(j=0,len=ref.length;j<len;j++){action=ref[j];if(action.type==='flow'){startsFlow=true;}}
terminal=startsFlow;if(actionset._terminal!==terminal){return actionset._terminal=terminal;}};Flow.prototype.isMoveableAction=function(action){var ref;if(!action){return true;}
return(ref=action.type)!=='flow'&&ref!=='end_ussd';};Flow.prototype.saveAction=function(actionset,action){var as,found,idx,j,k,lastAction,len,len1,previous,ref,ref1;actionset._lastActionMissingTranslation=null;if(action.type==="end_ussd"){actionset.destination=null;Plumb.updateConnection(actionset);this.applyActivity(actionset,$rootScope.activity);}
found=false;lastAction=null;ref=actionset.actions;for(idx=j=0,len=ref.length;j<len;idx=++j){previous=ref[idx];lastAction=previous;if(previous.uuid===action.uuid){if(!this.isMoveableAction(action)){actionset.actions.splice(idx,1);actionset.actions.push(action);found=true;}else{actionset.actions.splice(idx,1,action);found=true;}
break;}}
if(!found){action.uuid=uuid();if(!this.isMoveableAction(lastAction)){actionset.actions.splice(actionset.actions.length-1,0,action);}else{actionset.actions.push(action);}}
Plumb.recalculateOffsets(actionset.uuid);found=false;ref1=Flow.flow.action_sets;for(k=0,len1=ref1.length;k<len1;k++){as=ref1[k];if(as.uuid===actionset.uuid){found=true;break;}}
if(!found){Flow.flow.action_sets.push(actionset);}
if(Flow.flow.action_sets.length===1){if(!Flow.flow.action_sets[0].destination){$timeout(function(){return DragHelper.showSaveResponse($('#'+Flow.flow.action_sets[0].uuid+' .source'));},0);}}
this.checkTerminal(actionset);return this.markDirty();};return Flow;})());}]);ModalController=function($scope,$modalInstance,type,title,body,hideCancel,details,ok){if(hideCancel==null){hideCancel=false;}
if(details==null){details=null;}
if(ok==null){ok=null;}
$scope.type=type;$scope.title=title;$scope.body=body;$scope.error=error;$scope.details=details;$scope.hideCancel=hideCancel;if(ok){$scope.okButton=ok;$scope.ok=function(){return $modalInstance.close(true);};}else{$scope.okButton="Ok";$scope.ok=function(){return $modalInstance.dismiss("cancel");};}
$scope.cancel=function(){return $modalInstance.dismiss("cancel");};return $scope.showHelpWidget=function(){if(UserVoice){return UserVoice.push(['show',{mode:'contact'}]);}};};}).call(this);(function(){var AttachmentViewerController,NodeEditorController,SimpleMessageController,TerminalWarningController,TranslateRulesController,TranslationController,app,defaultActionSetType,defaultRuleSetType,version,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i;}return-1;};app=angular.module('temba.controllers',['ui.bootstrap','temba.services','ngAnimate']);version=new Date().getTime();defaultRuleSetType=function(){if(window.ivr){return'wait_digit';}else if(window.ussd){return'wait_menu';}else{return'wait_message';}};defaultActionSetType=function(){if(window.ivr){return'say';}else if(window.ussd){return'end_ussd';}else{return'reply';}};app.controller('RevisionController',['$scope','$rootScope','$log','$timeout','Flow','Revisions',function($scope,$rootScope,$log,$timeout,Flow,Revisions){$scope.revisions=function(){return Revisions.revisions;};$scope.apply=function(){return $scope.applyDefinition(Flow.flow);};$scope.cancel=function(){if(Revisions.original){return $scope.applyDefinition(Revisions.original);}else{return $scope.hideRevisions();}};$scope.showRevision=function(revision){var j,len,other,ref;ref=Revisions.revisions;for(j=0,len=ref.length;j<len;j++){other=ref[j];other.selected=false;}
revision.selected=true;if(!Revisions.original){Revisions.original=Flow.flow;}
return Revisions.getRevision(revision).then(function(){return $scope.showDefinition(Revisions.definition);});};$scope.showDefinition=function(definition,onChange){$rootScope.visibleActivity=false;Flow.flow=null;jsPlumb.reset();return $timeout(function(){Flow.flow=definition;if(onChange){return onChange();}},0);};$scope.applyDefinition=function(definition){var action,actionset,j,k,l,len,len1,len2,markDirty,other,ref,ref1,ref2;ref=definition.action_sets;for(j=0,len=ref.length;j<len;j++){actionset=ref[j];ref1=actionset.actions;for(k=0,len1=ref1.length;k<len1;k++){action=ref1[k];if(!action.uuid){action.uuid=uuid();}}}
ref2=Revisions.revisions;for(l=0,len2=ref2.length;l<len2;l++){other=ref2[l];other.selected=false;}
markDirty=false;if(definition.metadata.revision!==Revisions.original.metadata.revision){definition.metadata.saved_on=Revisions.original.metadata.saved_on;markDirty=true;}
return $scope.showDefinition(definition,function(){$scope.hideRevisions();if(markDirty){return Flow.markDirty();}});};return $scope.hideRevisions=function(){Revisions.original=null;$rootScope.visibleActivity=true;return $rootScope.showRevisions=false;};}]);app.controller('FlowController',['$scope','$rootScope','$timeout','$log','$interval','$upload','Flow','Plumb','DragHelper','utils',function($scope,$rootScope,$timeout,$log,$interval,$upload,Flow,Plumb,DragHelper,utils){var showConnectTransferTo,showDialog,showRecentDelay;$rootScope.gearLinks=[];$rootScope.ivr=window.ivr;$rootScope.ussd=window.ussd;$rootScope.hasAirtimeService=window.hasAirtimeService;$scope.getContactFieldName=function(ruleset){if(!ruleset._contactFieldName){ruleset._contactFieldName=Flow.getContactField(ruleset);}
return ruleset._contactFieldName;};$scope.getFlowFieldName=function(ruleset){if(!ruleset._flowFieldName){ruleset._flowFieldName=Flow.getFlowField(ruleset);}
return ruleset._flowFieldName;};$scope.clickGearMenuItem=function(id){var modal;if(id==='default_language'){modal=new ConfirmationModal(gettext('Default Language'),gettext('The default language for the flow is used for contacts which have no preferred language. Are you sure you want to set the default language for this flow to')+' <span class="attn">'+Flow.language.name+"</span>?");modal.addClass('warning');modal.setListeners({onPrimary:function(){return $scope.setBaseLanguage(Flow.language);}});modal.show();}
return false;};$rootScope.activityInterval=5000;$scope.init=function(){return Flow.fetch(window.flowId,function(){$scope.updateActivity();return $scope.flow=Flow.flow;});};showDialog=function(title,body,okButton,hideCancel){var resolveObj;if(okButton==null){okButton='Okay';}
if(hideCancel==null){hideCancel=true;}
resolveObj={title:function(){return title;},body:function(){return body;},okButton:function(){return okButton;},hideCancel:function(){return hideCancel;}};$scope.dialog=utils.openModal("/partials/modal",SimpleMessageController,resolveObj);return $scope.dialog;};showConnectTransferTo=function(){var modal;modal=new ConfirmationModal(gettext("TransferTo Disconnected"),gettext("No TransferTo account connected. Please first connect your TransferTo account."));modal.addClass('airtime-warning');modal.setPrimaryButton(gettext("Connect TransferTo Account"));modal.setListeners({onPrimary:function(){return document.location.href=window.connectAirtimeServiceURL;}});modal.show();};$scope.showRevisionHistory=function(){return $scope.$evalAsync(function(){return $rootScope.showRevisions=true;});};$scope.setBaseLanguage=function(lang){if(Flow.languages[0].name===gettext('Default')){Flow.languages.splice(0,1);}
Flow.languages.splice(Flow.languages.indexOf(lang),1);Flow.languages.unshift(lang);Flow.flow.base_language=lang.iso_code;return $timeout(function(){$scope.setLanguage(lang);return Flow.markDirty();},0);};$scope.onFileSelect=function($files,actionset,action,save){var file,media_encoding,media_type,modal,parts,ref,ref1,ref2,ref3,scope,uploadURL;if(save==null){save=true;}
if(window.dragging||!window.mutable){return;}
scope=this;if($files.length>1){showDialog("Too Many Files","To upload a file, please drag and drop one file for each step.");return;}
file=$files[0];if(!file.type){return;}
if(action.type==='say'&&file.type!=='audio/wav'&&file.type!=='audio/x-wav'){showDialog('Invalid Format','Voice prompts must in wav format. Please choose a wav file and try again.');return;}
parts=file.type.split('/');media_type=parts[0];media_encoding=parts[1];if((ref=action.type)==='reply'||ref==='send'){if(media_type!=='audio'&&media_type!=='video'&&media_type!=='image'){showDialog('Invalid Attachment','Attachments must be either video, audio, or an image.');return;}
if(media_type==='audio'&&(media_encoding!=='mp3'&&media_encoding!=='m4a'&&media_encoding!=='wav'&&media_encoding!=='ogg'&&media_encoding!=='oga')){showDialog('Invalid Format','Audio attachments must be encoded as mp3, m4a, wav, ogg or oga files.');return;}}
if(((ref1=action.type)==='reply'||ref1==='send')&&(file.size>20000000||(file.name.endsWith('.jpg')&&file.size>500000))){showDialog('File Size Exceeded',"The file size should be less than 500kB for images and less than 20MB for audio and video files. Please choose another file and try again.");return;}
if(action.type==='say'&&action._translation_recording){modal=showDialog('Overwrite Recording','This step already has a recording, would you like to replace this recording with '+file.name+'?','Overwrite Recording',false);modal.result.then(function(value){if(value==='ok'){action._translation_recording=null;return scope.onFileSelect($files,actionset,action);}});return;}
if(((ref2=action.type)==='reply'||ref2==='send')&&action._media){modal=showDialog('Overwrite Attachment','This step already has an attachment, would you like to replace this attachment with '+file.name+'?','Overwrite Attachemnt',false);modal.result.then(function(value){if(value==='ok'){action._media=null;action._attachURL=null;action._attachType=null;return scope.onFileSelect($files,actionset,action);}});return;}
action.uploading=true;uploadURL=null;if(action.type==='say'){uploadURL=window.uploadURL;}
if((ref3=action.type)==='reply'||ref3==='send'){uploadURL=window.uploadMediaURL;}
if(!uploadURL){return;}
$scope.upload=$upload.upload({url:uploadURL,data:{actionset:actionset.uuid,action:action.uuid!=null?action.uuid:''},file:file}).progress(function(evt){$log.debug("percent: "+parseInt(100.0*evt.loaded/evt.total));}).success(function(data,status,headers,config){var ref4;if(action.type==='say'){if(!action.recording){action.recording={};}
action.recording[Flow.language.iso_code]=data['path'];}
if((ref4=action.type)==='reply'||ref4==='send'){if(!action.media){action.media={};}
action.media[Flow.language.iso_code]=file.type+':'+data['path'];}
action.uploading=false;action.dirty=true;if(action.media&&action.media[Flow.language.iso_code]){parts=action.media[Flow.language.iso_code].split(/:(.+)/);if(parts.length>=2){action._media={mime:parts[0],url:window.mediaURL+parts[1],type:parts[0].split('/')[0]};}}
if(save){Flow.saveAction(actionset,action);}});};$scope.scheduleActivityUpdate=function(){$timeout(function(){return $scope.updateActivity();},$rootScope.activityInterval);return $rootScope.activityInterval+=200;};$scope.setLanguage=function(lang){Flow.setMissingTranslation(false);Flow.language=lang;$scope.language=lang;return Plumb.repaint();};$scope.updateActivity=function(){if(window.simulation){return;}
return $.ajax({type:"GET",url:activityURL,cache:false,success:function(data,status,xhr){$rootScope.is_starting=data.is_starting;if(xhr.status===200&&data.activity){$rootScope.activity={active:data.activity,visited:data.visited};if(!window.simulation){$rootScope.visibleActivity=$rootScope.activity;}
return $scope.scheduleActivityUpdate();}},error:function(status){console.log("Error:");return console.log(status);}});};$scope.$watch((function(){return Flow.flow;}),function(current){$scope.flow=Flow.flow;$scope.languages=Flow.languages;$scope.language=Flow.language;if(current){jsPlumb.bind('connectionDrag',function(connection){return $scope.onConnectorDrag(connection);});jsPlumb.bind('connectionDragStop',function(connection){return $scope.onConnectorDrop(connection);});return jsPlumb.bind('beforeDrop',function(sourceId,targetId){return $scope.onBeforeConnectorDrop(sourceId,targetId);});}else{jsPlumb.unbind('connectionDrag');return jsPlumb.unbind('connectionDragStop');}});$scope.$watch((function(){return $rootScope.visibleActivity;}),function(){var j,len,node,ref;if($rootScope.visibleActivity){if(Flow.flow){ref=Flow.flow.rule_sets.concat(Flow.flow.action_sets);for(j=0,len=ref.length;j<len;j++){node=ref[j];Flow.applyActivity(node,$rootScope.visibleActivity);}}}});$scope.getSource=function(category){return category.sources[0];};$scope.onBeforeConnectorDrop=function(props){var errorMessage;errorMessage=Flow.getConnectionError(props.sourceId,props.targetId);if(errorMessage){$rootScope.ghost.hide();$rootScope.ghost=null;showDialog('Invalid Connection',errorMessage);return false;}
return true;};$scope.onConnectorDrop=function(connection){var actionset,category,createdNewNode,ghost,msg,ruleset,source,targetId,to;if(!$rootScope.ghost&&connection.targetId===connection.suspendedElementId){return false;}
$(connection.sourceId).parent().removeClass('reconnecting');source=connection.sourceId.split('_');createdNewNode=false;if($rootScope.ghost){ghost=$rootScope.ghost;targetId=uuid();if(!ghost.hasClass('collision')){if(ghost.hasClass('actions')){msg={};msg[Flow.flow.base_language]='';actionset={x:ghost[0].offsetLeft,y:ghost[0].offsetTop,uuid:targetId,exit_uuid:uuid(),actions:[{type:defaultActionSetType(),msg:msg,uuid:uuid()}]};$scope.clickAction(actionset,actionset.actions[0],connection.sourceId);createdNewNode=true;}else{category={};category[Flow.flow.base_language]="All Responses";ruleset={x:ghost[0].offsetLeft,y:ghost[0].offsetTop,uuid:targetId,label:"Response "+(Flow.flow.rule_sets.length+1),operand:"@step.value",ruleset_type:defaultRuleSetType(),rules:[{test:{test:"true",type:"true"},category:category,uuid:uuid()}]};$scope.clickRuleset(ruleset,connection.sourceId);createdNewNode=true;}}
$rootScope.ghost.hide();$rootScope.ghost=null;}
if(!createdNewNode){to=connection.targetId;if(!connection.source){to=null;}}
return $timeout(function(){Flow.updateDestination(connection.sourceId,to);return Flow.markDirty();},0);};$scope.onConnectorDrag=function(connection){var scope;DragHelper.hide();$(connection.sourceId).parent().addClass('reconnecting');scope=$rootScope.ussd?'rules':jsPlumb.getSourceScope(connection.sourceId);$rootScope.ghost=$('.ghost.'+scope);return $timeout(function(){return $rootScope.ghost.show();},0);};$scope.createFirstAction=function(){var actionset,msg;msg={};msg[Flow.flow.base_language]='';actionset={x:100,y:0,uuid:uuid(),exit_uuid:uuid(),actions:[{uuid:uuid(),type:defaultActionSetType(),msg:msg}]};return this.clickAction(actionset,actionset.actions[0]);};$scope.createFirstUssd=function(){var category,ruleset;category={};category[Flow.flow.base_language]="All Responses";ruleset={x:100,y:0,uuid:uuid(),label:"Response "+(Flow.flow.rule_sets.length+1),webhook_action:null,ruleset_type:defaultRuleSetType(),rules:[{test:{test:"true",type:"true"},category:category,uuid:uuid()}],config:{}};return this.clickRuleset(ruleset);};$scope.notBaseLanguageFilter=function(lang){return lang.iso_code!==$scope.flow.base_language;};$scope.translatableRuleFilter=function(rule){return rule.type==='contains_any';};$scope.lastActionMissingTranslation=function(actionset){var lastAction;lastAction=actionset.actions[actionset.actions.length-1];if(lastAction){return lastAction._missingTranslation;}};$scope.broadcastToStep=function(event,uuid,count){window.broadcastToNode(uuid,count);return event.stopPropagation();};$scope.addNote=function(event){return Flow.addNote(event.offsetX,event.offsetY);};$scope.removeNote=function(note){return Flow.removeNote(note);};$scope.clickRuleset=function(ruleset,dragSource){var resolveObj;if(dragSource==null){dragSource=null;}
if(window.dragging||!window.mutable){return;}
DragHelper.hide();if(ruleset.ruleset_type==='airtime'&&!$rootScope.hasAirtimeService){showConnectTransferTo();return;}
if(Flow.language&&Flow.flow.base_language!==Flow.language.iso_code&&!dragSource){resolveObj={languages:function(){return{from:Flow.flow.base_language,to:Flow.language.iso_code};},ruleset:function(){return ruleset;},translation:function(){return{};}};if(Flow.flow.flow_type==='U'){resolveObj.translation=function(){return{from:ruleset.config.ussd_message[Flow.flow.base_language],to:ruleset.config.ussd_message[Flow.language.iso_code]};};}
return $scope.dialog=utils.openModal("/partials/translate_rules",TranslateRulesController,resolveObj);}else{if(window.ivr){resolveObj={options:function(){return{nodeType:'ivr',ruleset:ruleset,dragSource:dragSource};},scope:$scope,flowController:function(){return $scope;}};return $scope.dialog=utils.openModal("/partials/node_editor",NodeEditorController,resolveObj);}else{resolveObj={options:function(){return{nodeType:'rules',ruleset:ruleset,dragSource:dragSource};},flowController:function(){return $scope;}};return $scope.dialog=utils.openModal("/partials/node_editor",NodeEditorController,resolveObj);}}};$scope.confirmRemoveWebhook=function(event,ruleset){var removeWarning;if(window.dragging||!window.mutable){return;}
removeWarning=$(event.target).parent().children('.remove-warning');if(removeWarning.is(':visible')){Plumb.repaint();Flow.markDirty();}else{removeWarning.fadeIn();$timeout(function(){return removeWarning.fadeOut();},1500);}
return false;};$scope.confirmRemoveRuleset=function(event,ruleset){var removeWarning;if(window.dragging||!window.mutable){return;}
removeWarning=$(event.target).parent().children('.remove-warning');if(removeWarning.is(':visible')){Flow.removeRuleset(ruleset.uuid);}else{removeWarning.fadeIn();$timeout(function(){return removeWarning.fadeOut();},1500);}
return false;};$scope.confirmRemoveConnection=function(connection){var modal;modal=new ConfirmationModal(gettext('Remove'),gettext('Are you sure you want to remove this connection?'));modal.addClass('alert');modal.setListeners({onPrimary:function(){Flow.removeConnection(connection);return Flow.markDirty();}});modal.show();return false;};$scope.clickActionSource=function(actionset){var connection,resolveObj,source;if(actionset._terminal){resolveObj={actionset:function(){return actionset;},flowController:function(){return $scope;}};return $scope.dialog=utils.openModal("/partials/modal",TerminalWarningController,resolveObj);}else{if(window.mutable){source=$("#"+actionset.uuid+"> .source");connection=Plumb.getSourceConnection(source);if(connection){return $scope.confirmRemoveConnection(connection);}else{return $timeout(function(){return DragHelper.showSaveResponse($('#'+actionset.uuid+' .source'));},0);}}}};$scope.clickRuleSource=function(category){var connection,source;if(window.mutable){source=$("#"+category.sources[0]+"> .source");connection=Plumb.getSourceConnection(source);if(connection){return $scope.confirmRemoveConnection(connection);}else{return $timeout(function(){return DragHelper.showSendReply($('#'+category.sources[0]+' .source'));},0);}}};$scope.addAction=function(actionset){var resolveObj;if(window.dragging||!window.mutable){return;}
resolveObj={options:function(){return{nodeType:'actions',actionset:actionset,action:{type:defaultActionSetType(),uuid:uuid()}};},flowController:function(){return $scope;}};return $scope.dialog=utils.openModal("/partials/node_editor",NodeEditorController,resolveObj);};$scope.moveActionUp=function(actionset,action){return Flow.moveActionUp(actionset,action);};$scope.isMoveable=function(action){return Flow.isMoveableAction(action);};$scope.hasEndUssd=function(actionset){var ref;return(ref=actionset.actions)!=null?ref.some(function(action){return action.type==="end_ussd";}):void 0;};$scope.confirmRemoveAction=function(event,actionset,action){var removeWarning;if(window.dragging||!window.mutable){return;}
removeWarning=$(event.target).parent().children('.remove-warning');if(removeWarning.is(':visible')){Flow.removeAction(actionset,action);}else{removeWarning.fadeIn();$timeout(function(){return removeWarning.fadeOut();},1500);}
return false;};$scope.playRecording=function(action_uuid){$log.debug("Play audio: "+action_uuid);$('#'+action_uuid+"_audio").each(function(){var audio;audio=$(this)[0];if(!audio.paused){audio.pause();return audio.currentTime=0;}});return $('#'+action_uuid+"_audio")[0].play();};$scope.clickAction=function(actionset,action,dragSource){var fromMedia,fromMediaSplit,mimeType,ref,resolveObj,toMedia,toMediaSplit,translations;if(dragSource==null){dragSource=null;}
if(window.dragging||!window.mutable){return;}
DragHelper.hide();if(Flow.language&&Flow.flow.base_language!==Flow.language.iso_code){if((ref=action.type)==="send"||ref==="reply"||ref==="say"||ref==="end_ussd"){translations=[{name:'Message Text',from:action.msg[Flow.flow.base_language],to:action.msg[Flow.language.iso_code],fromQuickReplies:action.quick_replies||[]}];if(action.media&&action.media[Flow.flow.base_language]){fromMedia=action.media[Flow.flow.base_language];toMedia=action.media[Flow.language.iso_code];fromMediaSplit=fromMedia!=null?fromMedia.split(':'):void 0;toMediaSplit=toMedia!=null?toMedia.split(':'):void 0;mimeType=fromMediaSplit!=null?fromMediaSplit[0].split('/'):void 0;if((mimeType!=null?mimeType.length:void 0)===1){translations.push({name:'Attachment',type:mimeType,from:fromMediaSplit[1],to:toMediaSplit!=null?toMediaSplit[1]:void 0,input:true});}}
resolveObj={language:function(){return{from:Flow.flow.base_language,to:Flow.language.iso_code,name:Flow.language.name};},translations:function(){return translations;}};$scope.dialog=utils.openModal("/partials/translation_modal",TranslationController,resolveObj);$scope.dialog.opened.then(function(){return $('textarea').focus();});return $scope.dialog.result.then(function(translations){var j,len,ref1,results,translated,translation;action=utils.clone(action);for(j=0,len=translations.length;j<len;j++){translation=translations[j];results=action.msg;translated=((ref1=translation.to)!=null?ref1.strip().length:void 0)>0?translation.to:null;if((translation.fromQuickReplies!=null)&&translation.fromQuickReplies!==[]){action.quick_replies=translation.fromQuickReplies;}
if(translation.name==="Attachment"){results=action.media;if(translated){translated=translation.type+':'+translated;}}
if(translated){results[Flow.language.iso_code]=translated;}else{delete results[Flow.language.iso_code];}}
return Flow.saveAction(actionset,action);},(function(){return $log.info("Modal dismissed at: "+new Date());}));}}else{resolveObj={options:function(){return{nodeType:'actions',actionset:actionset,action:action,dragSource:dragSource};},flowController:function(){return $scope;}};return $scope.dialog=utils.openModal("/partials/node_editor",NodeEditorController,resolveObj);}};$scope.mouseMove=function($event){$rootScope.activityInterval=5000;if($rootScope.ghost){utils.checkCollisions($rootScope.ghost);if($rootScope.ghost.hasClass('collision')){if($("#flow .drop-hover").length>0){$rootScope.ghost.hide();}else{$rootScope.ghost.show();}}
$rootScope.ghost.offset({left:$event.pageX-($rootScope.ghost.width()/2),top:$event.pageY});}
return false;};showRecentDelay=null;$scope.hideRecentMessages=function(){$timeout.cancel(showRecentDelay);if(this.category){this.category._showMessages=false;this.$parent.ruleset._showMessages=false;}
if(this.action_set){return this.action_set._showMessages=false;}};$scope.showRecentMessages=function(){var hovered;hovered=this;return showRecentDelay=$timeout(function(){var action_set,category,ruleset;if(hovered.action_set){action_set=hovered.action_set;action_set._showMessages=true;Flow.fetchRecentMessages([action_set.exit_uuid],action_set.destination).then(function(response){return action_set._messages=response.data;});}
if(hovered.category){category=hovered.category;ruleset=hovered.$parent.ruleset;ruleset._showMessages=true;category._showMessages=true;return Flow.fetchRecentMessages(category.sources,category.target).then(function(response){return category._messages=response.data;});}},500);};return $scope.clickShowActionMedia=function(){var action,clicked,resolveObj;clicked=this;action=clicked.action;resolveObj={action:function(){return action;},type:function(){return"attachment-viewer";}};return $scope.dialog=utils.openModal("/partials/attachment_viewer",AttachmentViewerController,resolveObj);};}]);TranslateRulesController=function($scope,$modalInstance,Flow,utils,languages,ruleset,translation){var j,len,ref,rule;$scope.translation=translation;ruleset=utils.clone(ruleset);ref=ruleset.rules;for(j=0,len=ref.length;j<len;j++){rule=ref[j];if(rule.category){rule._translation={category:{},test:{},label:{}};rule._translation.category['from']=rule.category[Flow.flow.base_language];rule._translation.category['to']=rule.category[Flow.language.iso_code];if(typeof rule.test.test==="object"){rule._translation.test['from']=rule.test.test[Flow.flow.base_language];rule._translation.test['to']=rule.test.test[Flow.language.iso_code];}}
if(ruleset.ruleset_type==='wait_menu'&&rule.label){$scope.translation=translation;rule._translation.label['from']=rule.label[Flow.flow.base_language];rule._translation.label['to']=rule.label[Flow.language.iso_code];}}
$scope.ruleset=ruleset;$scope.languages=languages;$scope.language=Flow.language;$scope.ok=function(){var inputs,k,l,len1,len2,ref1,ref2,ref3;inputs=[];ref1=ruleset.rules;for(k=0,len1=ref1.length;k<len1;k++){rule=ref1[k];if(rule.category){if(rule._translation.category.to&&rule._translation.category.to.strip().length>0){rule.category[Flow.language.iso_code]=rule._translation.category.to;}else{delete rule.category[Flow.language.iso_code];}
if(typeof rule.test.test==="object"){if(rule._translation.test.to&&rule._translation.test.to.strip().length>0){rule.test.test[Flow.language.iso_code]=rule._translation.test.to;inputs.push(rule._translation.test.to);}else{delete rule.test.test[Flow.language.iso_code];}}}}
if($scope.hasInvalidFields(inputs)){return true;}
if(Flow.flow.flow_type==='U'){ruleset.config.ussd_message[Flow.language.iso_code]=$scope.translation.to;}
if(ruleset.ruleset_type==='wait_menu'){ref2=ruleset.rules;for(l=0,len2=ref2.length;l<len2;l++){rule=ref2[l];if(rule._translation.label.to&&rule._translation.label.to.strip().length>0){rule.label[Flow.language.iso_code]=rule._translation.label.to;}else{if((ref3=rule.label)!=null){delete ref3[Flow.language.iso_code];}}}}
Flow.replaceRuleset(ruleset);return $modalInstance.close("");};return $scope.cancel=function(){return $modalInstance.dismiss("cancel");};};TranslationController=function($rootScope,$scope,$modalInstance,language,translations,Flow){$scope.translations=translations;$scope.language=language;$scope.ok=function(translations){var translation;if($scope.hasInvalidFields((function(){var j,len,results1;results1=[];for(j=0,len=translations.length;j<len;j++){translation=translations[j];results1.push(translation.to);}
return results1;})())){return;}
return $modalInstance.close(translations);};return $scope.cancel=function(){return $modalInstance.dismiss("cancel");};};NodeEditorController=function($rootScope,$scope,$modalInstance,$timeout,$log,Flow,flowController,Plumb,utils,options){var INTERRUPTED_TYPE,action,actionset,airtimeAmountConfig,config,country,countryAirtime,countryCode,countryConfig,flow,formData,found,j,k,l,lang,len,len1,len2,len3,len4,len5,len6,len7,len8,len9,m,minutes,n,num,o,option,p,q,r,randomBuckets,ref,ref1,ref10,ref2,ref3,ref4,ref5,ref6,ref7,ref8,ref9,rule,ruleset,s,seenOrgCountries,startsFlow,stopWatching,toRemove;$scope.flow=Flow.flow;$scope.nodeType=options.nodeType;$scope.ivr=window.ivr;$scope.ussd=window.ussd;$scope.options=options;$scope.contactFields=Flow.contactFieldSearch;$scope.updateContactFields=Flow.updateContactSearch;$scope.actionConfigs=Flow.actions;$scope.rulesetConfigs=Flow.rulesets;$scope.operatorConfigs=Flow.operators;$scope.languages=utils.clone(Flow.languages).filter(function(lang){return lang.name!=="Default";});$scope.channels=Flow.channels;formData={};formData.resthook="";if(options.nodeType==='rules'||options.nodeType==='ivr'){ruleset=options.ruleset;formData.previousRules=ruleset.rules;formData.groups=[];ref=ruleset.rules;for(j=0,len=ref.length;j<len;j++){rule=ref[j];if(rule.test.type==='in_group'){formData.groups.push(rule.test.test);}}
if(ruleset.ruleset_type==='random'){randomBuckets=[];ref1=ruleset.rules;for(k=0,len1=ref1.length;k<len1;k++){rule=ref1[k];if(rule.test.type==='between'){randomBuckets.push({name:rule.category,destination:rule.destination,_base:rule.category[Flow.flow.base_language]});}}
formData.randomBuckets=randomBuckets;formData.buckets=randomBuckets.length;}
action={type:defaultActionSetType(),uuid:uuid()};actionset={_switchedFromRule:true,x:ruleset.x,y:ruleset.y,uuid:uuid(),exit_uuid:uuid(),actions:[action]};}else if(options.nodeType==='actions'){actionset=options.actionset;action=options.action;if(action.type==="lang"){found=false;ref2=$scope.languages;for(l=0,len2=ref2.length;l<len2;l++){lang=ref2[l];if(lang.iso_code===action.lang){found=true;break;}}
if(!found){$scope.languages.push({name:action.name,iso_code:action.lang});$scope.languages.sort(function(a,b){if(a.name<b.name){return-1;}
if(a.name>b.name){return 1;}
return 0;});}}
ruleset={_switchedFromAction:true,x:actionset.x,y:actionset.y,uuid:uuid(),label:"Response "+(Flow.flow.rule_sets.length+1),operand:"@step.value",ruleset_type:defaultRuleSetType(),rules:[{test:{test:"true",type:"true"},category:'All Responses',uuid:uuid()}]};ruleset.rules[0].category={_base:'All Responses'};ruleset.rules[0].category[Flow.flow.base_language]='All Responses';}
formData.timeoutOptions=[{value:1,text:'1 minute'},{value:2,text:'2 minutes'},{value:3,text:'3 minutes'},{value:4,text:'4 minutes'},{value:5,text:'5 minutes'},{value:10,text:'10 minutes'},{value:15,text:'15 minutes'},{value:30,text:'30 minutes'},{value:60,text:'1 hour'},{value:120,text:'2 hours'},{value:180,text:'3 hours'},{value:360,text:'6 hours'},{value:720,text:'12 hours'},{value:1080,text:'18 hours'},{value:1440,text:'1 day'},{value:2880,text:'2 days'},{value:4320,text:'3 days'},{value:10080,text:'1 week'}];minutes=5;formData.hasTimeout=false;ref3=ruleset.rules;for(m=0,len3=ref3.length;m<len3;m++){rule=ref3[m];if(rule.test.type==='timeout'){minutes=rule.test.minutes;formData.hasTimeout=true;break;}}
formData.timeout=formData.timeoutOptions[0];ref4=formData.timeoutOptions;for(n=0,len4=ref4.length;n<len4;n++){option=ref4[n];if(option.value===minutes){formData.timeout=option;}}
formData.webhook_action='GET';if(ruleset.config){formData.webhook=ruleset.config.webhook;formData.webhook_action=ruleset.config.webhook_action;formData.webhook_headers=ruleset.config.webhook_headers||[];formData.isWebhookAdditionalOptionsVisible=formData.webhook_headers.length>0;}else{formData.webhook_headers=[];formData.isWebhookAdditionalOptionsVisible=false;}
formData.rulesetConfig=Flow.getRulesetConfig({type:ruleset.ruleset_type});$scope.webhookAdditionalOptions=function(){if(formData.isWebhookAdditionalOptionsVisible===true){formData.isWebhookAdditionalOptionsVisible=false;}else{formData.isWebhookAdditionalOptionsVisible=true;}
if(formData.webhook_headers.length===0){return $scope.addNewWebhookHeader();}};$scope.addNewWebhookHeader=function(){if(formData.webhook_headers===void 0){formData.webhook_headers=[];}
return formData.webhook_headers.push({name:'',value:''});};$scope.removeWebhookHeader=function(index){formData.webhook_headers.splice(index,1);if(formData.webhook_headers.length===0){return $scope.addNewWebhookHeader();}};$scope.updateActionForm=function(config){$scope.invalidFields=null;if(config.type==='email'){if(typeof $scope.action.msg==='object'){if(Flow.flow.base_language in $scope.action.msg){return $scope.action.msg=$scope.action.msg[Flow.flow.base_language];}else{return $scope.action.msg='';}}}};$scope.showFlip=function(){return actionset.actions.length<2;};INTERRUPTED_TYPE='interrupted_status';$scope.ruleset=utils.clone(ruleset);$scope.removed=[];flow=Flow.flow;$scope.flowFields=Flow.getFlowFields(ruleset);$scope.fieldIndexOptions=[{text:'first',id:0},{text:'second',id:1},{text:'third',id:2},{text:'fourth',id:3},{text:'fifth',id:4},{text:'sixth',id:5},{text:'seventh',id:6},{text:'eighth',id:7},{text:'ninth',id:8}];$scope.fieldDelimiterOptions=[{text:'space',id:' '},{text:'plus',id:'+'},{text:'period',id:'.'}];formData.flowField=Flow.getFieldSelection($scope.flowFields,$scope.ruleset.operand,true);formData.contactField=Flow.getFieldSelection($scope.contactFields,$scope.ruleset.operand,false);config=$scope.ruleset.config;if(!config){config={};}
formData.fieldIndex=Flow.getFieldSelection($scope.fieldIndexOptions,config.field_index,true);formData.fieldDelimiter=Flow.getFieldSelection($scope.fieldDelimiterOptions,config.field_delimiter,true);airtimeAmountConfig=[];seenOrgCountries=[];ref5=angular.copy(Flow.channel_countries);for(o=0,len5=ref5.length;o<len5;o++){country=ref5[o];countryAirtime=country;countryCode=country.code;if(config[countryCode]){countryAirtime.amount=parseFloat(config[countryCode]['amount']);}else{countryAirtime.amount=0;}
seenOrgCountries.push(countryCode);airtimeAmountConfig.push(countryAirtime);}
for(countryCode in config){countryConfig=config[countryCode];if(indexOf.call(seenOrgCountries,countryCode)<0){airtimeAmountConfig.push(countryConfig);}}
formData.airtimeAmountConfig=airtimeAmountConfig;if(ruleset.config){formData.flow=ruleset.config.flow;}else{formData.flow={};}
$scope.rulesetTypeChanged=function(){$scope.invalidFields=null;if($scope.formData.rulesetConfig.type==="random"){if(!formData.buckets){formData.buckets=2;}
return $scope.updateRandomBuckets();}};$scope.updateRandomBuckets=function(){var i,p,ref6,ref7;formData=$scope.formData;if(!formData.randomBuckets){formData.randomBuckets=[];}
for(i=p=ref6=formData.randomBuckets.length,ref7=formData.buckets;p<ref7;i=p+=1){formData.randomBuckets.push({_base:"Bucket "+(i+1)});}
return formData.randomBuckets.splice(formData.buckets);};$scope.hasRules=function(){var ref6;if($scope.formData.rulesetConfig){return ref6=$scope.formData.rulesetConfig.type,indexOf.call(Flow.supportsRules,ref6)>=0;}};$scope.isRuleVisible=function(rule){var ref6;return ref6=flow.flow_type,indexOf.call(rule._config.filter,ref6)>=0;};$scope.getFlowsUrl=function(flow){var url;url="/flow/?_format=select2";if(Flow.flow.flow_type==='S'){return url+"&flow_type=S";}
if(Flow.flow.flow_type==='F'){return url+"&flow_type=F&flow_type=V";}
if(Flow.flow.flow_type==='V'){return url+"&flow_type=V";}
return url;};$scope.isPausingRuleset=function(){return Flow.isPausingRulesetType($scope.formData.rulesetConfig.type);};$scope.remove=function(rule){var index;$scope.removed.push(rule);index=$scope.ruleset.rules.indexOf(rule);return $scope.ruleset.rules.splice(index,1);};$scope.numericRule={test:{type:'between'},config:Flow.getOperatorConfig('between')};toRemove=[];ref6=$scope.ruleset.rules;for(p=0,len6=ref6.length;p<len6;p++){rule=ref6[p];if(!rule.category){toRemove.push(rule);continue;}
rule._config=Flow.getOperatorConfig(rule.test.type);if((ref7=rule.test.type)==='date_before'||ref7==='date_after'||ref7==='date_equal'){rule.test._base=rule.test.test.slice(15,-1);}else if(rule.test.type!=="between"&&rule.test.type!=="ward"){if(rule.test.test){if(rule._config.localized){rule.test._base=rule.test.test[Flow.flow.base_language];}else{rule.test={_base:rule.test.test};}}}
rule.category._base=rule.category[Flow.flow.base_language];}
if(window.ivr){$scope.numbers=(function(){var q,results1;results1=[];for(num=q=1;q<=9;num=++q){results1.push({number:num,uuid:uuid()});}
return results1;})();$scope.numbers.push({number:0,uuid:uuid()});ref8=$scope.ruleset.rules;for(q=0,len7=ref8.length;q<len7;q++){rule=ref8[q];num=parseInt(rule.test._base);if(num>=0&&num<=9){if(num===0){num=10;}
$scope.numbers[num-1].category=rule.category;$scope.numbers[num-1].uuid=rule.uuid;$scope.numbers[num-1].destination=rule.destination;}}}
for(r=0,len8=toRemove.length;r<len8;r++){rule=toRemove[r];$scope.remove(rule);}
$scope.sortableOptions={forcePlaceholderSize:true,scroll:false,placeholder:"sort-placeholder"};$scope.updateCategory=function(rule){var categoryName;if(!rule.category._autoName){return;}
categoryName=$scope.getDefaultCategory(rule);if(rule.category){return rule.category._base=categoryName;}else{return rule.category={_base:categoryName};}};$scope.isVisibleOperator=function(operator){var ref9;return ref9=flow.flow_type,indexOf.call(operator.filter,ref9)>=0;};$scope.isVisibleRulesetType=function(rulesetConfig){var ref9,valid;valid=(ref9=flow.flow_type,indexOf.call(rulesetConfig.filter,ref9)>=0);if((rulesetConfig.type==='flow_field'||rulesetConfig.type==='form_field')&&$scope.flowFields.length===0){return false;}
if(rulesetConfig.type==='contact_field'&&$scope.contactFields.length===0){return false;}
if(rulesetConfig.type==='airtime'&&!$rootScope.hasAirtimeService){return false;}
return valid;};$scope.getDefaultCategory=function(rule){var categoryName,days,named,op,words;categoryName='';if(rule.test&&rule.test._base){categoryName=rule.test._base.strip();}
op=rule._config.type;if(op==="between"){if(rule.test.min){categoryName=rule.test.min;}
if(rule.test.min&&rule.test.max){categoryName+=' - ';}
if(rule.test.max){categoryName+=rule.test.max;}}else if(op==="number"){categoryName="numeric";}else if(op==="ward"){categoryName="ward";}else if(op==="district"){categoryName="district";}else if(op==="state"){categoryName="state";}else if(op==="phone"){categoryName="phone";}else if(op==="has_email"){categoryName="email";}else if(op==="regex"){categoryName="matches";}else if(op==="date"){categoryName="is a date";}else if(op==="date_before"||op==="date_equal"||op==="date_after"){days=rule.test._base;if(days){if(days[0]==='-'){categoryName="today "+days;}else{categoryName="today +"+days;}
if(days==='1'||days==='-1'){categoryName=categoryName+" day";}else{categoryName=categoryName+" days";}
if(op==='date_before'){categoryName="< "+categoryName;}else if(op==='date_equal'){categoryName="= "+categoryName;}else if(op==='date_after'){categoryName="> "+categoryName;}}}else if(op==="contains"||op==="contains_any"||op==="starts"){words=categoryName.trim().split(/\b/);if(words){categoryName=words[0].toUpperCase();if(categoryName.length>1){categoryName=categoryName.charAt(0)+categoryName.substr(1).toLowerCase();}}}else{named=Flow.opNames[op];if(named){categoryName=named+categoryName;}}
return categoryName.substr(0,36);};$scope.isRuleComplete=function(rule){var complete;complete=true;if(!rule.category||!rule.category._base){complete=false;}else if(rule._config.operands===1&&!rule.test._base){complete=false;}else if(rule._config.type==='between'&&(!rule.test.min||!rule.test.max)){complete=false;}else if(rule._config.type==='ward'&&(!rule.test.state||!rule.test.district)){complete=false;}
return complete;};stopWatching=$scope.$watch((function(){return $scope.ruleset;}),function(){var complete,len9,ref10,ref9,s;complete=true;ref9=$scope.ruleset.rules;for(s=0,len9=ref9.length;s<len9;s++){rule=ref9[s];if((ref10=rule._config.type)==='airtime_status'||ref10==='subflow'||ref10==='timeout'||ref10===INTERRUPTED_TYPE){continue;}
complete=complete&&$scope.isRuleComplete(rule);if(!complete){break;}}
if(complete&&$scope.ruleset.ruleset_type!=='wait_menu'){return $scope.ruleset.rules.splice($scope.ruleset.rules.length-1,0,{uuid:uuid(),test:{type:window.ivr?"starts":"contains_any"},category:{_autoName:true,_base:''},_config:window.ivr?Flow.getOperatorConfig('starts'):Flow.getOperatorConfig('contains_any')});}},true);$scope.updateRules=function(ruleset,rulesetConfig,splitEditor){var bucket,category,group,i1,idx,interruptedCategory,interruptedDestination,interruptedRuleUuid,j1,len10,len11,len12,len13,len14,len15,len16,len17,len18,len9,min,newRule,new_rule,old_groups,otherCategory,otherDestination,otherRuleUuid,ref10,ref11,ref12,ref13,ref14,ref15,ref16,ref17,ref18,ref19,ref20,ref21,ref9,rules,s,size,t,timeoutCategory,timeoutDestination,timeoutRuleUuid,u,v,validRules,w,x,y,z;rules=[];if(rulesetConfig.rules){validRules={};ref9=rulesetConfig.rules;for(s=0,len9=ref9.length;s<len9;s++){rule=ref9[s];validRules[rule.test.type]=true;}
ref10=ruleset.rules;for(t=0,len10=ref10.length;t<len10;t++){rule=ref10[t];if(validRules[rule.test.type]){rules.push(rule);}}
ref11=rulesetConfig.rules;for(u=0,len11=ref11.length;u<len11;u++){rule=ref11[u];found=false;ref12=ruleset.rules;for(v=0,len12=ref12.length;v<len12;v++){new_rule=ref12[v];if(angular.equals(new_rule.test,rule.test)){found=true;break;}}
if(!found){newRule={uuid:uuid(),test:rule.test,category:{}};newRule.category[Flow.flow.base_language]=rule.name;rules.push(newRule);}}}
if(ruleset.ruleset_type==='random'){rules=[];size=1.0/$scope.formData.randomBuckets.length;min=0;ref13=$scope.formData.randomBuckets;for(idx=w=0,len13=ref13.length;w<len13;idx=++w){bucket=ref13[idx];if(!bucket.name){bucket.name={};}
bucket.name[Flow.flow.base_language]=bucket._base;rules.push({uuid:uuid(),test:{type:'between',min:""+min,max:""+(min+size)},category:bucket.name,destination:bucket.destination});min+=size;}}
if(ruleset.ruleset_type==='group'){old_groups={};if(formData.previousRules){ref14=formData.previousRules;for(x=0,len14=ref14.length;x<len14;x++){rule=ref14[x];if(rule.test.type==='in_group'){if(rule.test.test.uuid){old_groups[rule.test.test.uuid]=rule;}}}}
ref15=splitEditor.omnibox.selected.groups;for(y=0,len15=ref15.length;y<len15;y++){group=ref15[y];if(typeof group==='string'){group={name:group};}
if(group.id&&group.id in old_groups){rules.push(old_groups[group.id]);}else{category={};category[Flow.flow.base_language]=group.name;rule={uuid:uuid(),test:{type:'in_group',test:{name:group.name}},category:category};if(group.id){rule.test.test['uuid']=group.id;}
rules.push(rule);}}}
if(ruleset.ruleset_type==='wait_digit'){ref16=$scope.numbers;for(z=0,len16=ref16.length;z<len16;z++){option=ref16[z];if(option.category&&option.category._base){rule={uuid:option.uuid,destination:option.destination,category:option.category,test:{type:'eq',test:option.number}};rule.category[Flow.flow.base_language]=option.category._base;rules.push(rule);}}}
if($scope.hasRules()){ref17=ruleset.rules;for(i1=0,len17=ref17.length;i1<len17;i1++){rule=ref17[i1];if((ref18=rule._config.type)==='true'||ref18==='timeout'||ref18===INTERRUPTED_TYPE){continue;}
if((!rule.category||!rule.category._base)&&rule._config.type==='between'&&rule.test.min&&rule.test.max){rule.category={_base:rule.test.min+" - "+rule.test.max};}
if(!rule.category||(rule.category._base.strip().length===0)){continue;}
rule.test.type=rule._config.type;if((ref19=rule._config.type)==="date_before"||ref19==="date_after"||ref19==="date_equal"){rule.test.test="@(date.today + "+rule.test._base+")";}else{if(rule._config.localized){if(!rule.test.test){rule.test.test={};}
rule.test.test[Flow.flow.base_language]=rule.test._base;}else{rule.test.test=rule.test._base;}}
rule.category[Flow.flow.base_language]=rule.category._base;if(rule.category){rules.push(rule);}}}
otherRuleUuid=uuid();otherDestination=null;timeoutRuleUuid=uuid();timeoutDestination=null;timeoutCategory={};timeoutCategory[Flow.flow.base_language]='No Response';interruptedRuleUuid=uuid();interruptedDestination=null;interruptedCategory={};interruptedCategory[Flow.flow.base_language]="Interrupted";ref20=ruleset.rules;for(j1=0,len18=ref20.length;j1<len18;j1++){rule=ref20[j1];if(rule._config.type==='true'){otherDestination=rule.destination;otherCategory=rule.category;otherRuleUuid=rule.uuid;}else if(rule._config.type==='timeout'){timeoutDestination=rule.destination;timeoutCategory=rule.category;timeoutRuleUuid=rule.uuid;}else if(rule._config.type===INTERRUPTED_TYPE){interruptedDestination=rule.destination;interruptedCategory=rule.category;interruptedRuleUuid=rule.uuid;}}
if(!otherCategory){otherCategory={};}
otherCategory[Flow.flow.base_language]='Other';if(!rulesetConfig.rules&&!rulesetConfig.hide_other){rules.push({_config:Flow.getOperatorConfig("true"),test:{test:"true",type:"true"},destination:otherDestination,uuid:otherRuleUuid,category:otherCategory});}
if($scope.formData.hasTimeout&&ruleset.ruleset_type==='wait_message'){rules.push({_config:Flow.getOperatorConfig("timeout"),test:{type:"timeout",minutes:$scope.formData.timeout.value},destination:timeoutDestination,uuid:timeoutRuleUuid,category:timeoutCategory});}
rules=(function(){var k1,len19,results1;results1=[];for(k1=0,len19=rules.length;k1<len19;k1++){rule=rules[k1];if(Flow.isRuleAllowed($scope.ruleset.ruleset_type,rule.test.type)){results1.push(rule);}}
return results1;})();if(rules.length===1||(rules.length===2&&rules[1].test.type==='timeout')){otherCategory[Flow.flow.base_language]='All Responses';}
if((ref21=ruleset.ruleset_type)==='wait_menu'||ref21==='wait_ussd'){rules.push({_config:Flow.getOperatorConfig(INTERRUPTED_TYPE),test:{test:"interrupted",type:INTERRUPTED_TYPE},destination:interruptedDestination,uuid:interruptedRuleUuid,category:interruptedCategory});}
return $scope.ruleset.rules=rules;};$scope.okRules=function(splitEditor){var fieldChecks,len9,ref9,s;fieldChecks=[];if(formData.rulesetConfig.type==='expression'){fieldChecks.push($scope.ruleset.operand);}
if(formData.rulesetConfig.type==='webhook'){fieldChecks.push(formData.webhook);}
ref9=$scope.ruleset.rules;for(s=0,len9=ref9.length;s<len9;s++){rule=ref9[s];if(rule.test._base){fieldChecks.push(rule.test._base);}}
if($scope.hasInvalidFields(fieldChecks)){return;}
stopWatching();$modalInstance.close("");return $timeout(function(){var airtimeConfig,amount,changedRulesetType,connections,contactField,elt,flowField,header,len10,len11,len12,len13,ref10,ref11,ref12,rulesetConfig,t,u,v,w,webhook_headers;ruleset=$scope.ruleset;if(!ruleset.config){ruleset.config={};}
formData=$scope.formData;rulesetConfig=formData.rulesetConfig;contactField=formData.contactField;flowField=formData.flowField;airtimeAmountConfig=formData.airtimeAmountConfig;flow=formData.flow;changedRulesetType=ruleset.ruleset_type!==rulesetConfig.type;ruleset.ruleset_type=rulesetConfig.type;if(rulesetConfig.type==='subflow'){flow=splitEditor.flow.selected[0];ruleset.config={flow:{name:flow.text,uuid:flow.id}};}
if(rulesetConfig.type==='random'){ruleset.operand='@(RAND())';}
if(rulesetConfig.type==='form_field'){ruleset.operand='@flow.'+flowField.id;ruleset.config.field_index=$scope.formData.fieldIndex.id;ruleset.config.field_delimiter=$scope.formData.fieldDelimiter.id;}else if(rulesetConfig.type==='airtime'){airtimeConfig={};for(t=0,len10=airtimeAmountConfig.length;t<len10;t++){elt=airtimeAmountConfig[t];amount=elt.amount;try{elt.amount=parseFloat(amount);}catch(error){elt.amount=0;}
airtimeConfig[elt.code]=elt;}
ruleset.config=airtimeConfig;}else if(rulesetConfig.type==='resthook'){ruleset.config={'resthook':splitEditor.resthook.selected[0]['id']};}else if(rulesetConfig.type==='webhook'){webhook_headers=[];ref10=formData.webhook_headers;for(u=0,len11=ref10.length;u<len11;u++){header=ref10[u];if(header.name){webhook_headers.push(header);}}
ruleset.config={webhook:formData.webhook,webhook_action:formData.webhook_action,webhook_headers:webhook_headers};}else if(rulesetConfig.type==='contact_field'){ruleset.operand='@contact.'+contactField.id;}else if(rulesetConfig.type==='flow_field'){ruleset.operand='@flow.'+flowField.id;}else if(rulesetConfig.type==='wait_message'){ruleset.operand='@step.value';}
$scope.updateRules(ruleset,rulesetConfig,splitEditor);Plumb.disconnectRules($scope.removed);connections=Plumb.getConnectionMap({target:actionset.uuid});if(ruleset._switchedFromAction){Flow.removeActionSet($scope.actionset);}
if(changedRulesetType){connections=Plumb.getConnectionMap({target:ruleset.uuid});Flow.removeRuleset(ruleset.uuid);ruleset.uuid=uuid();ref11=ruleset.rules;for(v=0,len12=ref11.length;v<len12;v++){rule=ref11[v];rule.uuid=uuid();}}
Flow.replaceRuleset(ruleset,false);ref12=ruleset.rules;for(w=0,len13=ref12.length;w<len13;w++){rule=ref12[w];if(rule.destination&&!Flow.isConnectionAllowed(ruleset.uuid+'_'+rule.uuid,rule.destination)){Flow.updateDestination($scope.ruleset.uuid+'_'+rule.uuid,null);}}
if(ruleset._switchedFromAction||changedRulesetType){$timeout(function(){var results1,ruleset_uuid,source;ruleset_uuid=ruleset.uuid;results1=[];for(source in connections){if(Flow.isConnectionAllowed(source,ruleset_uuid)){results1.push(Flow.updateDestination(source,ruleset_uuid));}else{results1.push(void 0);}}
return results1;},0);}
if($scope.options.dragSource){if(Flow.isConnectionAllowed($scope.options.dragSource,ruleset.uuid)){Flow.updateDestination($scope.options.dragSource,ruleset.uuid);}}
return Flow.markDirty();},0);};$scope.clickShowActionMedia=function(){var clicked,resolveObj;clicked=this;action=clicked.action;resolveObj={action:function(){return action;},type:function(){return"attachment-viewer";}};return $scope.dialog=utils.openModal("/partials/attachment_viewer",AttachmentViewerController,resolveObj);};$scope.onFileSelect=function($files,actionset,action){return flowController.onFileSelect($files,actionset,action,false);};$scope.cancel=function(){stopWatching();return $modalInstance.dismiss("cancel");};$scope.action=utils.clone(action);$scope.showAttachOptions=false;$scope.showAttachVariable=false;if($scope.action._attachURL){$scope.showAttachOptions=true;$scope.showAttachVariable=true;}else{$scope.action._attachType="image";}
if(($scope.options.dragSource!=null)||!(($scope.action.quick_replies!=null)&&$scope.action.quick_replies!==void 0&&$scope.action.quick_replies.length>0)){$scope.quickReplies=[];$scope.showQuickReplyButton=true;}else{$scope.quickReplies=$scope.action.quick_replies;$scope.showQuickReplyButton=false;}
formData.isActionWebhookAdditionalOptionsVisible=((ref9=$scope.action.webhook_headers)!=null?ref9.length:void 0)>0;$scope.actionWebhookAdditionalOptions=function(){if(formData.isActionWebhookAdditionalOptionsVisible===true){formData.isActionWebhookAdditionalOptionsVisible=false;}else{formData.isActionWebhookAdditionalOptionsVisible=true;}
if($scope.action.webhook_headers.length===0){return $scope.addNewActionWebhookHeader();}};$scope.addNewActionWebhookHeader=function(){if(!$scope.action.webhook_headers){$scope.action.webhook_headers=[];}
return $scope.action.webhook_headers.push({name:'',value:''});};$scope.removeActionWebhookHeader=function(index){$scope.action.webhook_headers.splice(index,1);if($scope.action.webhook_headers.length===0){return $scope.addNewActionWebhookHeader();}};$scope.addNewQuickReply=function(){var addQuickReply;$scope.showQuickReplyButton=false;if($scope.quickReplies.length<11){addQuickReply={};addQuickReply[$scope.base_language]='';return $scope.quickReplies.push(addQuickReply);}};$scope.removeQuickReply=function(index){$scope.quickReplies.splice(index,1);if($scope.quickReplies.length===0){return $scope.showQuickReplyButton=true;}};$scope.actionset=actionset;$scope.flowId=window.flowId;startsFlow=false;ref10=actionset.actions;for(s=0,len9=ref10.length;s<len9;s++){action=ref10[s];if(action.type==='flow'&&$scope.action.uuid!==action.uuid){startsFlow=true;break;}}
$scope.base_language=Flow.flow.base_language;if(!$scope.action.lang){$scope.action.lang=Flow.base_language;}
$scope.methods=['GET','POST'];if(!$scope.action.action){$scope.action.action='GET';}
$scope.config=Flow.getActionConfig({type:$scope.action.type});$scope.validActionFilter=function(action){var ref11,valid;valid=false;if(action.filter){valid=(ref11=flow.flow_type,indexOf.call(action.filter,ref11)>=0);}
if(startsFlow&&action.type==='flow'){return false;}
return valid;};$scope.savePlay=function(){if($scope.hasInvalidFields([$scope.action.url])){return;}
$scope.action.type='play';Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.removeAttachment=function(){delete $scope.action['media'];delete $scope.action['_media'];return delete $scope.action['_attachURL'];};$scope.saveMessage=function(message,type,hasAttachURL){var inputs,key,len10,ref11,t,translation;if(type==null){type='reply';}
if(hasAttachURL==null){hasAttachURL=false;}
inputs=[message];if(hasAttachURL){inputs.push($scope.action._attachURL);}
if($scope.hasInvalidFields(inputs)){return;}
if(typeof $scope.action.msg!=="object"){$scope.action.msg={};}
$scope.action.msg[$scope.base_language]=message;$scope.action.type=type;if(hasAttachURL&&$scope.action._attachURL){if(!$scope.action.media){$scope.action.media={};}
$scope.action.media[$scope.base_language]=$scope.action._attachType+':'+$scope.action._attachURL;ref11=Object.keys($scope.action.media);for(t=0,len10=ref11.length;t<len10;t++){key=ref11[t];if(key!==$scope.base_language){translation=$scope.action.media[key];$scope.action.media[key]=$scope.action._attachType+':'+translation.split(':')[1];}}}else if(!$scope.action._media){delete $scope.action['media'];}
if($scope.quickReplies.length>0){$scope.action.quick_replies=$scope.quickReplies;}else{delete $scope.action['quick_replies'];}
Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveSend=function(omnibox,message){var contact,contacts,group,groups,len10,len11,ref11,ref12,t,u;if($scope.hasInvalidFields([message])){return;}
groups=[];ref11=omnibox.groups;for(t=0,len10=ref11.length;t<len10;t++){group=ref11[t];groups.push({uuid:group.id,name:group.name});}
$scope.action.groups=groups;contacts=[];ref12=omnibox.contacts;for(u=0,len11=ref12.length;u<len11;u++){contact=ref12[u];contacts.push({uuid:contact.id,name:contact.name});}
$scope.action.contacts=contacts;$scope.action.variables=omnibox.variables;$scope.action.type='send';if(typeof $scope.action.msg!=="object"){$scope.action.msg={};}
$scope.action.msg[$scope.base_language]=message;Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveLabels=function(msgLabels){var label,labels,len10,len11,msgLabel,ref11,t,u;labels=[];for(t=0,len10=msgLabels.length;t<len10;t++){msgLabel=msgLabels[t];found=false;ref11=Flow.labels;for(u=0,len11=ref11.length;u<len11;u++){label=ref11[u];if(label.id===msgLabel){found=true;labels.push({uuid:label.id,name:label.text});}}
if(!found){labels.push({uuid:msgLabel.id,name:msgLabel.text});}}
$scope.action.labels=labels;$scope.action.type='add_label';Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveGroups=function(actionType,omnibox,allGroups){var group,groups,len10,len11,ref11,ref12,t,u,variable;$scope.action.type=actionType;groups=[];if(!allGroups){ref11=omnibox.groups;for(t=0,len10=ref11.length;t<len10;t++){group=ref11[t];if(group.id&&group.name){groups.push({uuid:group.id,name:group.name});}else{groups.push(group);}}}
$scope.action.msg=void 0;$scope.action.groups=groups;if(!allGroups){ref12=omnibox.variables;for(u=0,len11=ref12.length;u<len11;u++){variable=ref12[u];$scope.action.groups.push(variable.id);}}
Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveUpdateContact=function(field,value){if($scope.hasInvalidFields([value])){return;}
if(field.id.indexOf('[_NEW_]')===0&&field.text.indexOf("Add new variable:")===0){field.text=field.text.slice(18);field.id=field.id.slice(7);field.id=field.id.toLowerCase().replace(/[^0-9a-z]+/gi,' ').strip().replace(/[^0-9a-z]+/gi,'_');Flow.contactFieldSearch.push({id:field.id,text:field.text});Flow.updateContactSearch.push({id:field.id,text:field.text});}
$scope.action.type='save';$scope.action.field=field.id;$scope.action.label=field.text;$scope.action.value=value;Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveWebhook=function(method,url){var header,len10,ref11,t,webhook_headers;if($scope.hasInvalidFields([url])){return;}
webhook_headers=[];if($scope.action.webhook_headers){ref11=$scope.action.webhook_headers;for(t=0,len10=ref11.length;t<len10;t++){header=ref11[t];if(header.name){webhook_headers.push(header);}}}
$scope.action.type='api';$scope.action.action=method;$scope.action.webhook=url;$scope.action.webhook_headers=webhook_headers;Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveEmail=function(addresses){var address,len10,t,to;if($scope.hasInvalidFields([$scope.action.subject,$scope.action.msg])){return;}
to=[];for(t=0,len10=addresses.length;t<len10;t++){address=addresses[t];to.push(address.text);}
$scope.action.emails=to;$scope.action.type='email';Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveStartFlow=function(flow,omnibox){var contact,contacts,group,groups,len10,len11,ref11,ref12,t,u;if(omnibox){$scope.action.type='trigger-flow';groups=[];ref11=omnibox.groups;for(t=0,len10=ref11.length;t<len10;t++){group=ref11[t];groups.push({uuid:group.id,name:group.name});}
$scope.action.groups=groups;contacts=[];ref12=omnibox.contacts;for(u=0,len11=ref12.length;u<len11;u++){contact=ref12[u];contacts.push({uuid:contact.id,name:contact.name});}
$scope.action.contacts=contacts;$scope.action.variables=omnibox.variables;}else{$scope.action.type='flow';}
flow=flow[0];$scope.action.flow={uuid:flow.id,name:flow.text};Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveLanguage=function(){var len10,ref11,t;$scope.action.type='lang';ref11=Flow.languages;for(t=0,len10=ref11.length;t<len10;t++){lang=ref11[t];if(lang.iso_code===$scope.action.lang){$scope.action.name=lang.name;break;}}
Flow.saveAction(actionset,$scope.action);return $modalInstance.close();};$scope.saveChannel=function(){var chan,definition,len10,ref11,t;definition={type:'channel',channel:$scope.action.channel,uuid:$scope.action.uuid};ref11=Flow.channels;for(t=0,len10=ref11.length;t<len10;t++){chan=ref11[t];if(chan.uuid===$scope.action.channel){definition['name']=chan.name;}}
Flow.saveAction(actionset,definition);return $modalInstance.close();};$scope.ok=function(){var connections;$timeout(function(){$('.submit').click();if(options.dragSource){return Flow.updateDestination(options.dragSource,actionset.uuid);}},0);if(actionset._switchedFromRule){connections=Plumb.getConnectionMap({target:$scope.ruleset.uuid});Flow.removeRuleset($scope.ruleset.uuid);return $timeout(function(){var results1,source;results1=[];for(source in connections){results1.push(Flow.updateDestination(source,actionset.uuid));}
return results1;},0);}};$scope.cancel=function(){return $modalInstance.dismiss("cancel");};return $scope.formData=formData;};SimpleMessageController=function($scope,$modalInstance,$log,title,body,okButton,hideCancel){if(hideCancel==null){hideCancel=true;}
$scope.title=title;$scope.body=body;$scope.okButton=okButton;$scope.hideCancel=hideCancel;$scope.ok=function(){return $modalInstance.close("ok");};$scope.cancel=function(){return $modalInstance.close("cancel");};};TerminalWarningController=function($scope,$modalInstance,$log,actionset,flowController){var action,j,len,ref,startsFlow;$scope.title="End of Flow";$scope.body="You must first add a response to this branch in order to extend it.";$scope.okButton="Add Response";startsFlow=false;ref=actionset.actions;for(j=0,len=ref.length;j<len;j++){action=ref[j];if(action.type==='flow'){startsFlow=true;break;}}
if(startsFlow){$scope.body="Once another flow is started, this flow can no longer continue. To extend this flow, remove any actions that start another flow.";$scope.okButton="Ok";}
$scope.ok=function(){$modalInstance.close("ok");if(!startsFlow){return flowController.addAction(actionset);}};return $scope.cancel=function(){return $modalInstance.dismiss("cancel");};};AttachmentViewerController=function($scope,$modalInstance,action,type){$scope.action=action;$scope.type=type;return $scope.cancel=function(){return $modalInstance.dismiss("cancel");};};}).call(this);(function(){var app;app=angular.module('temba.directives',['temba.services']);app.directive("node",["Plumb","Flow","DragHelper","utils","$timeout","$log",function(Plumb,Flow,DragHelper,utils,$timeout,$log){var link;link=function(scope,element,attrs){if(window.mutable){Plumb.makeTarget(attrs.id,attrs.dropScope);$timeout(function(){return jsPlumb.draggable(attrs.id,{containment:true,cancel:'.source',start:function(){DragHelper.hide();element.data('previous',element.offset());element.parents('#flow').addClass('dragging');element.addClass('dragging');return window.dragging=true;},drag:function(){utils.checkCollisions(element);return $(this).find("._jsPlumb_endpoint_anchor_").each(function(i,e){if($(e).hasClass("connect")){Plumb.repaint($(e).parent());}else{Plumb.repaint($(e));}});},stop:function(){element.parents('#flow').removeClass('dragging');element.removeClass('dragging');if(element.hasClass('collision')&&element.data('previous')){element.offset(element.data('previous'));element.data('previous',null);element.removeClass('collision');return Plumb.repaint();}else{scope.node.x=element[0].offsetLeft;scope.node.y=element[0].offsetTop;Flow.determineFlowStart();Plumb.setPageHeight();return $timeout(function(){window.dragging=false;return Flow.markDirty();},0);}}});},0);return scope.$on('$destroy',function(){return Plumb.removeElement(scope.node.uuid);});}};return{restrict:"A",scope:{node:'='},link:link};}]);app.directive("note",["$timeout","$log","Flow",function($timeout,$log,Flow){var link;link=function(scope,element,attrs){element.css('left',scope.note.x+'px').css('top',scope.note.y+'px');element.draggable({containment:'parent',stop:function(){scope.note.x=element[0].offsetLeft;scope.note.y=element[0].offsetTop;return $timeout(function(){return Flow.markDirty();},0);}});scope.$watch('note.title',function(current,prev){if(current!==prev){return Flow.markDirty();}});return scope.$watch('note.body',function(current,prev){if(current!==prev){return Flow.markDirty();}});};return{restrict:"A",scope:{note:'='},link:link};}]);app.directive("actionset",["$timeout","$log","Plumb","Flow",function($timeout,$log,Plumb,Flow){var link;link=function(scope,element,attrs){Plumb.updateConnection(scope.actionset);Flow.checkTerminal(scope.actionset);scope.addAction=function(){};return scope.$watch((function(){return scope.actionset._terminal;}),function(terminal){var source;if(terminal==null){terminal=false;}
source=$('#'+scope.actionset.uuid+' .source');if(terminal){source.addClass('terminal');Flow.updateDestination(scope.actionset.uuid,null);}else{source.removeClass('terminal');}
return $timeout(function(){return jsPlumb.setSourceEnabled(scope.actionset.uuid+'_source',!terminal);},0);});};return{link:link,scope:{actionset:'='}};}]);app.directive("action",["Plumb","Flow","$log",function(Plumb,Flow,$log){var link;link=function(scope,element,attrs){scope.updateTranslationStatus=function(action,baseLanguage,currentLanguage){var iso_code,mime_parts,parts,ref;action._missingTranslation=false;iso_code=Flow.flow.base_language;if(currentLanguage){iso_code=currentLanguage.iso_code;}
if((ref=action.type)==='send'||ref==='reply'||ref==='say'||ref==='end_ussd'){action._translation=action.msg[iso_code];if(action.recording){action._translation_recording=action.recording[iso_code];if(action._translation_recording){action._translation_recording=window.mediaURL+action._translation_recording;}}
action._media=null;action._attachURL=null;if(action.media&&action.media[iso_code]){parts=action.media[iso_code].split(/:(.+)/);if(parts.length>=2){mime_parts=parts[0].split('/');if(mime_parts.length>1){action._media={mime:parts[0],url:window.mediaURL+parts[1],type:mime_parts[0]};}else{action._attachURL=parts[1];action._attachType=mime_parts[0];}}}
if(action._translation===void 0){action._translation=action.msg[baseLanguage];action._missingTranslation=true;}else{action._missingTranslation=false;}}else{action._translation=null;action._missingTranslation=false;}
Flow.updateTranslationStats();return Plumb.repaint(element.parents('.node').find('.source'));};scope.$watch((function(){return scope.action.dirty;}),function(current){if(current){scope.action.dirty=false;return scope.updateTranslationStatus(scope.action,Flow.flow.base_language,Flow.language);}});scope.$watch((function(){return scope.action;}),function(){return scope.updateTranslationStatus(scope.action,Flow.flow.base_language,Flow.language);});return scope.$watch((function(){return Flow.language;}),function(){return scope.updateTranslationStatus(scope.action,Flow.flow.base_language,Flow.language);});};return{restrict:"A",link:link,scope:{action:'=action'}};}]);app.directive("actionName",["Flow",function(Flow){var link;link=function(scope,element,attrs){return scope.$watch((function(){return scope.ngModel;}),function(){var actionConfig;if(scope.ngModel){actionConfig=Flow.getActionConfig(scope.ngModel);scope.name=actionConfig.name;if(attrs['icon']==="show"){return scope.icon=actionConfig.icon;}}});};return{template:'<span class="icon [[icon]]"></span><span>[[name]]</span>',restrict:"C",link:link,scope:{ngModel:'='}};}]);app.directive("rulesetName",["Flow",function(Flow){var link;link=function(scope,element,attrs){return scope.$watch((function(){return scope.ngModel;}),function(){var rulesetConfig;if(scope.ngModel){rulesetConfig=Flow.getRulesetConfig(scope.ngModel);scope.name=rulesetConfig.name;if(attrs['icon']==="show"){return scope.icon=rulesetConfig.icon;}}});};return{template:'<span class="icon [[icon]]"></span><span>[[name]]</span>',restrict:"C",link:link,scope:{ngModel:'='}};}]);app.directive("ruleset",["Plumb","Flow","$log",function(Plumb,Flow,$log){var link;link=function(scope,element,attrs){Flow.replaceRuleset(scope.ruleset,false);scope.updateTranslationStatus=function(ruleset,baseLanguage,currentLanguage){var category,iso_code,item,j,k,len,len1,ref,ref1;iso_code=baseLanguage;if(currentLanguage){iso_code=currentLanguage.iso_code;}
ref=ruleset._categories;for(j=0,len=ref.length;j<len;j++){category=ref[j];category._missingTranslation=false;if(category.name){if(baseLanguage){category._translation=category.name[iso_code];if(category._translation===void 0){category._translation=category.name[baseLanguage];category._missingTranslation=true;}else{category._missingTranslation=false;}}else{category._translation=category.name;}}}
if(Flow.flow.flow_type==='U'){ruleset.config._ussd_translation=ruleset.config.ussd_message[iso_code];if(ruleset.config._ussd_translation===void 0||ruleset.config._ussd_translation===""){ruleset.config._ussd_translation=ruleset.config.ussd_message[baseLanguage];ruleset.config._missingTranslation=true;}else{ruleset.config._missingTranslation=false;}
if(ruleset.ruleset_type==="wait_menu"){ref1=ruleset.rules;for(k=0,len1=ref1.length;k<len1;k++){item=ref1[k];item._missingTranslation=false;if(item.label){item._translation=item.label[iso_code];if(item._translation===void 0||item._translation===""){item._translation=item.label[baseLanguage];item._missingTranslation=true;}}}}}
Flow.updateTranslationStats();return Plumb.repaint(element);};scope.$watch((function(){return scope.ruleset;}),function(){scope.updateTranslationStatus(scope.ruleset,Flow.flow.base_language,Flow.language);return Plumb.updateConnections(scope.ruleset);});return scope.$watch((function(){return Flow.language;}),function(){return scope.updateTranslationStatus(scope.ruleset,Flow.flow.base_language,Flow.language);});};return{restrict:"A",link:link,scope:{ruleset:'=ruleset'}};}]);app.directive("operatorName",["Flow",function(Flow){var link;link=function(scope,element,attrs){return scope.$watch((function(){return scope.ngModel;}),function(){var opConfig;opConfig=Flow.getOperatorConfig(scope.ngModel.type);return scope.verbose_name=opConfig.verbose_name;});};return{template:'<span>[[verbose_name]]</span>',restrict:"C",link:link,scope:{ngModel:'='}};}]);app.directive("source",['Plumb','$log',function(Plumb,$log){var link;link=function(scope,element,attrs){if(!attrs.id||!attrs.dropScope){return;}
if(window.mutable){Plumb.makeSource(attrs.id,attrs.dropScope);}
return scope.$on('$destroy',function(){if(jsPlumb.isSource(attrs.id)){return Plumb.removeElement(attrs.id);}});};return{link:link,restrict:'C'};}]);}).call(this);(function(){var appendMessage,checkForm,fitSimToScreen,hideSimulator,initSimulatorBody,initTextareaHeight,processForm,resetSimulator,resized,sendAudio,sendGPS,sendMessage,sendPhoto,sendVideo,showSimulator,toExpand,verifyNumberSimulator;window.simulation=false;window.moving_sim=false;window.level_classes={"I":"iinfo","W":"iwarn","E":"ierror"};window.legacy=true;$(function(){return $(window).scroll(function(evt){return fitSimToScreen();});});toExpand=$("#simulator textarea");initTextareaHeight=toExpand.height();initSimulatorBody=$(".simulator-body").height();resized=toExpand.height();toExpand.autosize({callback:function(){var currentResized,footer;currentResized=toExpand.height();if(currentResized!==resized){footer=currentResized+10;resized=currentResized;$(".simulator-footer").css("height",footer);$(".simulator-body").css("height",initSimulatorBody-footer+30);return $(".simulator-body").scrollTop($(".simulator-body")[0].scrollHeight);}}});checkForm=function(newMessage){var valid;valid=true;if(newMessage===""){$("#simulator textarea").addClass("error");valid=false;}else if(newMessage.length>160){$("#simulator textarea").val("");$("#simulator textarea").addClass("error");valid=false;}
toExpand.css("height",initTextareaHeight);$(".simulator-footer").css("height",initTextareaHeight+10);$(".simulator-body").css("height","360px");return valid;};window.resetForm=function(){$('.simulator-footer .media-button').hide();$('.simulator-footer .imessage').show();$("#simulator textarea").val("");$(".simulator-loading").css("display","none");$(".simulator-body").css("height","360px");return $("#simulator textarea").removeClass("error");};processForm=function(postData){var scope;scope=$('html').scope('scope');if(scope&&scope.saving){setTimeout(function(){return processForm(postData);},500);return;}
if(window.legacy){return window.sendUpdateLegacy(postData);}else{return window.sendUpdate(postData);}};window.sendSimulationMessage=function(new_message){return sendMessage(new_message);};sendMessage=function(newMessage){if(checkForm(newMessage)){if(newMessage==="/v1"||newMessage==="/v2"){window.legacy=newMessage==="/v1";if(newMessage==="/v2"){document.location.href=document.location.href.replace(/\/editor\//g,'/editor_next/');return;}
resetForm();setTimeout(function(){resetSimulator();if(window.legacy){return $('.simulator-content').removeClass('v2');}},500);return false;}
processForm({new_message:newMessage});return true;}};sendPhoto=function(){return processForm({new_photo:true});};sendVideo=function(){return processForm({new_video:true});};sendAudio=function(){return processForm({new_audio:true});};sendGPS=function(){return processForm({new_gps:true});};fitSimToScreen=function(){var showSim,sim,simBottom,simTop,top,workspace,workspaceBottom;top=$(window).scrollTop();sim=$("#simulator");workspace=$("#workspace");showSim=$("#show-simulator");if(top>110&&!sim.hasClass('scrollfix')){sim.addClass('scrollfix');showSim.addClass('scrollfix');}else if(top<=110&&sim.hasClass('scrollfix')){sim.removeClass('scrollfix');showSim.removeClass('scrollfix');}
simTop=sim.offset().top;simBottom=sim.height()+simTop;workspaceBottom=workspace.offset().top+workspace.height();if(simTop>top+10&&sim.hasClass('on-footer')){return sim.removeClass('on-footer');}else{if(simBottom>workspaceBottom-30&&!sim.hasClass('on-footer')){sim.addClass('on-footer');}
if(simBottom<workspaceBottom&&sim.hasClass('on-footer')){return sim.removeClass('on-footer');}}};window.updateActivity=function(data){var activity,i,len,node,ref,scope,top;if(window.simulation){scope=$('body').scope();if(scope){scope.$apply(function(){return scope.visibleActivity={active:data.activity,visited:data.visited};});}
ref=$('#workspace').children('.node');for(i=0,len=ref.length;i<len;i++){node=ref[i];node=$(node).data('object');node.setActivity(data);}}
activity=$('.activity:visible,.node .active:visible');if(activity){if(activity.offset()){top=activity.offset().top;return $('html, body').animate({scrollTop:top-200});}}};hideSimulator=function(){var moving_sim,scope,sim;moving_sim=true;sim=$("#simulator");sim.animate({right:-(sim.outerWidth()+10)},400,"easeOutExpo",function(){var showButton;sim.hide();showButton=$("#show-simulator");showButton.css({right:-(showButton.outerWidth()+10)});showButton.show();showButton.stop().animate({right:0,width:40},400,"easeOutExpo");return moving_sim=false;});window.simulation=false;$("#toolbar .actions").fadeIn();scope=$('body').scope();if(scope){scope.$apply(function(){return scope.visibleActivity=scope.activity;});}
if(window.is_voice){return window.hangup();}};showSimulator=function(reset){var messageCount;if(reset==null){reset=false;}
messageCount=$(".simulator-body").data('message-count');if(reset||!messageCount||messageCount===0){resetSimulator();}else{refreshSimulator();}
window.moving_sim=true;fitSimToScreen();$("#toolbar .actions").fadeOut();$("#show-simulator").stop().animate({right:'-110px'},200,function(){var sim;$(this).hide();$(this).find('.message').hide();sim=$("#simulator");sim.css({right:-(sim.outerWidth()+10)});sim.show();return sim.animate({right:30},400,"easeOutExpo",function(){$(".simulator-content textarea").focus();return window.moving_sim=false;});});return window.simulation=true;};window.refreshSimulator=function(){var scope;scope=$('html').scope('scope');if(scope&&scope.saving){setTimeout(refreshSimulator,500);return;}
if(window.legacy){return window.simStartLegacy();}else{return window.simStart();}};resetSimulator=function(){var scope;$('#simulator').removeClass('disabled');$(".simulator-body").html("");$(".simulator-body").append("<div class='ilog from'>One moment..</div>");$(".simulator-loading").css("display","none");$('.simulator-footer .media-button').hide();$('.simulator-footer .imessage').hide();scope=$('html').scope('scope');if(scope&&scope.saving){setTimeout(resetSimulator,500);return;}
if(window.legacy){return window.simStartLegacy();}else{return window.simStart();}};window.hangup=function(){$(".simulator-body").html("");return $.post(getSimulateURL(),JSON.stringify({hangup:true})).done(function(data){});};window.addMessage=function(text,type,metadata,level,onClick){var classes,ele;if(metadata==null){metadata=null;}
if(level==null){level=null;}
if(onClick==null){onClick=null;}
classes=["imsg"];if(type==="log"||type==="error"){classes=["ilog"];}
if(type==="MO"){classes.push("to");}else if(type==="MT"){classes.push("from");}else if(type==="error"){classes.push("ierror");}
if(level){classes.push(level_classes[level]);}
if(onClick){classes.push("link");}
ele="<div class=\""+classes.join(" ")+"\">";ele+=text;ele+="</div>";ele=$(ele);if(onClick){ele.bind("click",onClick);}
return ele=$(".simulator-body").append(ele);};appendMessage=function(newMessage,ussd){var imsgDiv;if(ussd==null){ussd=false;}
ussd=ussd?"ussd ":"";imsgDiv='<div class=\"imsg '+ussd+'to post-message\"></div>';$(imsgDiv).text(newMessage).appendTo(".simulator-body");$("#simulator textarea").val("");$(".simulator-loading").css("display","block");return $(".simulator-body").scrollTop($(".simulator-body")[0].scrollHeight);};$('#simulator .gps-button').on('click',function(){return sendGPS();});$('#simulator .photo-button').on('click',function(){return sendPhoto();});$('#simulator .video-button').on('click',function(){return sendVideo();});$('#simulator .audio-button').on('click',function(){return sendAudio();});$("#simulator .send-message").on("click",function(){var newMessage;newMessage=$("#simulator textarea").val();$(this).addClass("to-ignore");if(sendMessage(newMessage)){if(window.ussd&&newMessage.length<=182){return appendMessage(newMessage,true);}else if(newMessage.length<=160&&newMessage.length>0){return appendMessage(newMessage);}}});$("#simulator textarea").keypress(function(event){var newMessage;if(event.which===13){event.preventDefault();newMessage=$("#simulator textarea").val();if(sendMessage(newMessage)){if(newMessage){if(window.ussd&&newMessage.length<=182){return appendMessage(newMessage,true);}else if(newMessage.length<=160){return appendMessage(newMessage);}}}}});$("#show-simulator").hover(function(){if(!window.moving_sim){return $(this).stop().animate({width:'110px'},200,"easeOutBack",function(){return $(this).find('.message').stop().fadeIn('fast');});}},function(){if(!window.moving_sim){$(this).find('.message').hide();return $(this).stop().animate({width:'40px'},200,"easeOutBack",function(){});}});verifyNumberSimulator=function(){var modal;if(window.ivr){modal=new Modax(gettext("Start Test Call"),'/usersettings/phone/');modal.setIcon("icon-phone");modal.setListeners({onSuccess:function(){return showSimulator(true);}});return modal.show();}else if(window.ussd&&!window.has_ussd_channel){modal=new Modal(gettext("Missing USSD Channel"),gettext("There is no channel that supports USSD connected. Please connect a USSD channel first."));modal.setIcon("icon-phone");modal.setListeners({onPrimary:function(){return modal.dismiss();}});return modal.show();}else{return showSimulator();}};$("#show-simulator").click(function(){return verifyNumberSimulator();});$("#toggle-simulator").on("click",function(){if(!$("#simulator").is(":visible")){return verifyNumberSimulator();}else{return hideSimulator();}});$(".simulator-close").on("click",function(){return hideSimulator();});$(".simulator-refresh").on("click",function(){return resetSimulator();});}).call(this);(function(){window.getSimulateURL=function(){var scope;scope=$('html').scope();if(scope&&scope.language){return window.simulateURL+'?lang='+scope.language.iso_code;}
return window.simulateURL;};window.simStartLegacy=function(){return $.post(getSimulateURL(),JSON.stringify({has_refresh:true,version:"1"})).done(function(results){window.updateResultsLegacy(results);if(window.ivr&&window.simulation){return setTimeout(window.refreshSimulator,2000);}});};window.sendUpdateLegacy=function(postData){postData['version']="1";return $.post(getSimulateURL(),JSON.stringify(postData)).done(function(results){window.resetForm();return window.updateResultsLegacy(results);});};window.updateResultsLegacy=function(data){var attachment,direction,ele,ele_quick_replies,i,j,len,level,media_type,media_url,media_viewer_elt,metadata,model,msg,parts,quick_replies,ref,reply,ussd;ussd=window.ussd?"ussd":"";$(".simulator-body").html("");i=0;$('.simulator-body').data('message-count',data.messages.length);if(data.ruleset){$('.simulator-footer .media-button').hide();if(data.ruleset.ruleset_type==='wait_gps'){$('.simulator-footer .imessage').hide();$('.simulator-footer .gps-button').show();}else if(data.ruleset.ruleset_type==='wait_photo'){$('.simulator-footer .imessage').hide();$('.simulator-footer .photo-button').show();}else if(data.ruleset.ruleset_type==='wait_video'){$('.simulator-footer .imessage').hide();$('.simulator-footer .video-button').show();}else if(data.ruleset.ruleset_type==='wait_audio'){$('.simulator-footer .imessage').hide();$('.simulator-footer .audio-button').show();}else{$('.simulator-footer .imessage').show();}}else{$('.simulator-footer .media-button').hide();$('.simulator-footer .imessage').show();}
while(i<data.messages.length){msg=data.messages[i];model=((msg.model==="msg")?"imsg":"ilog");level=(msg.level!=null?level_classes[msg.level]:"");direction=((msg.direction==="O")?"from":"to");media_type=null;media_viewer_elt=null;quick_replies=null;metadata=msg.metadata;if(metadata&&(metadata.quick_replies!=null)){quick_replies="<div id='quick-reply-content'>";ref=metadata.quick_replies;for(j=0,len=ref.length;j<len;j++){reply=ref[j];quick_replies+="<button class=\"btn quick-reply\" data-payload=\""+reply+"\"> "+reply+"</button>";}
quick_replies+="</div>";}
if(msg.attachments&&msg.attachments.length>0){attachment=msg.attachments[0];parts=attachment.split(':');media_type=parts[0];media_url=parts.slice(1).join(":");if(media_type==='geo'){media_type='icon-pin_drop';}else{media_type=media_type.split('/')[0];if(media_type==='image'){media_type='icon-photo_camera';media_viewer_elt="<span class=\"media-file\"><img src=\""+media_url+"\"></span>";}else if(media_type==='video'){media_type='icon-videocam';media_viewer_elt="<span class=\"media-file\"><video controls src=\""+media_url+"\"></span>";}else if(media_type==='audio'){media_type='icon-mic';media_viewer_elt="<span class=\"media-file\"><audio controls src=\""+media_url+"\"></span>";}}}
ele="<div class=\""+model+" "+level+" "+direction+" "+ussd;if(media_type){ele+=" media-msg";}
ele+="\">";ele+=msg.text;ele+="</div>";if(quick_replies){ele_quick_replies="<div class='ilog "+level+" "+direction+" "+ussd+"'>";ele_quick_replies+=quick_replies;ele_quick_replies+="</div>";ele+=ele_quick_replies;}
if(media_type&&media_viewer_elt){ele+=media_viewer_elt;}
$(".simulator-body").append(ele);i++;}
$(".simulator-body").scrollTop($(".simulator-body")[0].scrollHeight);$("#simulator textarea").val("");$(".simulator-content textarea").focus();$(".btn.quick-reply").on("click",function(event){var payload;payload=event.target.innerText;return window.sendSimulationMessage(payload);});return window.updateActivity(data);};}).call(this);(function(){var getRequest,getStartRequest;getRequest=function(){return{events:[]};};getStartRequest=function(){var request,scope;scope=$("#ctlr").data('$scope');request=getRequest();request['trigger']={type:"manual",contact:{uuid:uuid(),name:contactName,urns:["tel:+12065551212"]},flow:{uuid:scope.flow.metadata.uuid,name:scope.flow.metadata.name},triggered_on:new Date()};return request;};window.simStart=function(){var request;window.session=null;window.resetForm();request=getStartRequest();return $.post(getSimulateURL(),JSON.stringify(request)).done(function(results){var scope;window.session=results.session;$(".simulator-body").html("");scope=$("#ctlr").data('$scope');window.addMessage("Entering the flow \""+scope.flow.metadata.name+"\"","log");return window.updateResults(results);});};window.sendUpdate=function(postData){var request;request=getRequest();request['session']=window.session;request['events']=[{type:"msg_received",msg:{text:postData.new_message,uuid:uuid(),urn:"tel:+12065551212",created_on:new Date()},created_on:new Date(),contact:window.session.contact}];return $.post(getSimulateURL(),JSON.stringify(request)).done(function(results){window.session=results.session;window.updateResults(results);return window.resetForm();});};window.showModal=function(title,body){var modal;modal=new ConfirmationModal(title,body);modal.show();return modal;};window.updateResults=function(data){var activity,event,group,i,j,k,key,l,lastExit,legacyFormat,len,len1,len2,len3,len4,m,ref,ref1,ref2,ref3,ref4,run,scope,segment,slugged,visited,webhookEvent;if(data.events){ref=data.events;for(i=0,len=ref.length;i<len;i++){event=ref[i];if(event.type==="broadcast_created"){window.addMessage(event.text,"MT");}else if(event.type==="msg_created"){window.addMessage(event.msg.text,"MT");}else if(event.type==="flow_triggered"){window.addMessage("Entering the flow \""+event.flow.name+"\"","log");}else if(event.type==="run_result_changed"){slugged=event.name.toLowerCase().replace(/([^a-z0-9]+)/g,'_');window.addMessage("Saving @flow."+slugged+" as \""+event.value+"\"","log");}else if(event.type==="contact_language_changed"){window.addMessage("Updated language to \""+event.language+"\"","log");}else if(event.type==="contact_name_changed"){window.addMessage("Updated name to \""+event.name+"\"","log");}else if(event.type==="contact_field_changed"){window.addMessage("Updated "+event.field.label+" to \""+event.value+"\"","log");}else if(event.type==="contact_group_added"){ref1=event.groups;for(j=0,len1=ref1.length;j<len1;j++){group=ref1[j];window.addMessage("Added to group \""+group.name+"\"","log");}}else if(event.type==="contact_group_removed"){ref2=event.groups;for(k=0,len2=ref2.length;k<len2;k++){group=ref2[k];window.addMessage("Removed from group \""+group.name+"\"","log");}}else if(event.type==="webhook_called"){if(event.status_code){webhookEvent=event;window.addMessage("Called "+event.url+" which returned a "+event.status_code+" response.","log",null,null,function(){var modal;modal=showModal("Webhook Results","<pre>"+webhookEvent.response+"</pre>");modal.setListeners({},true);return modal.hideSecondaryButton();});}else{window.addMessage("Couldn't reach "+event.url,"log");}}else if(event.type==="error"){window.addMessage(event.text,'error');if(event.fatal){$('#simulator').addClass('disabled');}}}}
$(".simulator-body").scrollTop($(".simulator-body")[0].scrollHeight);$("#simulator textarea").val("");if(data.session){if(data.session.status==='completed'){scope=$("#ctlr").data('$scope');window.addMessage("Exited the flow \""+scope.flow.metadata.name+"\"","log");$('#simulator').addClass('disabled');}
visited={};lastExit=null;ref3=data.session.runs;for(l=0,len3=ref3.length;l<len3;l++){run=ref3[l];ref4=run.path;for(m=0,len4=ref4.length;m<len4;m++){segment=ref4[m];if(lastExit){key=lastExit+':'+segment.node_uuid;if(!(key in visited)){visited[key]=0;}
visited[key]=visited[key]+1;}
lastExit=segment.exit_uuid;activity={};activity[segment.node_uuid]=1;}}
legacyFormat={'activity':activity,'visited':visited};return updateActivity(legacyFormat);}};}).call(this);